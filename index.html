<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invest | Lector PDF cartera (v3.22 — agregación, país desde country.json, sector desde sectores.json)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      html, body { height: 100%; }
      .mono { font-variant-numeric: tabular-nums; }
      .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.125rem .5rem; border-radius:.5rem; font-size:.75rem; }
      table thead th { position: sticky; top: 0; background: #f1f5f9; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script>
      'use strict';

      // ===== Utils =====
      const parseEsNumber = (s) => {
        if (s == null) return null;
        s = (''+s).replace(/\./g,'').replace(/,/g,'.').replace(/\s/g,'');
        const v = Number(s);
        return Number.isFinite(v) ? v : null;
      };
      const fmt = (n) => n != null ? n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
      const round2 = (n) => n==null?null:+(Math.round(n*100)/100).toFixed(2);

      // ===== Nombre (1ª línea útil) =====
      function cleanNameBlock(block){
        if (!block) return '';
        let lines=String(block).split(/\n+/).map(s=>s.replace(/\s{2,}/g,' ').trim()).filter(Boolean);
        const headerRe=/(VALOR NOMINAL|NOMBRE DEL VALOR|PRECIO POR T[ÍI]TULO|COTIZACI[ÓO]N EN EUR|PA[ÍI]S DE CUSTODIA|TRADE REPUBLIC|EXTRACTO|CUENTA DE VALORES|RESUMEN|IBAN|BIC|DEP[ÓO]SITO)/i;
        lines=lines.filter(l=>!headerRe.test(l)&&!/t[íi]t\.?/i.test(l));
        if(!lines.length) return '';
        let line=lines[0];
        line=line.replace(/^\d[\d\.,]*\s*t[íi]t\.?\s*/i,'');
        line=line.split(/ISIN\s*:/i)[0].trim();
        const qual=/\b(Registered|Actions?|Acciones?|Shares?|Shs|ADR|ADS|Ord\.?|Bearer|Nominative|EO\b|DL\b|Class|Serie|Series|Port\.?|Nominal)\b/i;
        const qm=qual.exec(line); if(qm) line=line.slice(0,qm.index).trim();
        line=line.replace(/[·•\-–—,:;]+$/,'').trim();
        return line;
      }

      // ===== Bloques por ISIN (corta resumen en el último) =====
      function buildBlocks(text){
        const re=/ISIN\s*:?[^A-Z0-9]*([A-Z0-9]{12})/gi;
        const matches=[]; let m;
        while((m=re.exec(text))!==null) matches.push({start:m.index, isin:m[1].toUpperCase()});
        const blocks=[];
        for(let i=0;i<matches.length;i++){
          const cur=matches[i];
          const nextStart=(i+1<matches.length)?matches[i+1].start:text.length;
          const pre=text.slice(Math.max(0,cur.start-600),cur.start);
          let post=text.slice(cur.start,nextStart);
          if (i === matches.length - 1) {
            post = post.replace(/N[ÚU]MERO\s+DE\s+POSICIONES[\s\S]*$/i, '');
            post = post.replace(/RESUMEN[\s\S]*$/i, '');
            post = post.replace(/TOTAL[\s\S]*$/i, '');
          }
          blocks.push({pre, post, isin:cur.isin});
        }
        return blocks;
      }

      // ===== Cotización EUR cerca del precio y con "EUR" =====
      function extractCotizacionEUR(post){
        const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
        if (!precioM) return null;
        const start = precioM.index + precioM[0].length;
        const ventana = post.slice(start, start + 200);
        const m = ventana.match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2}))\s*EUR/i);
        return m ? parseEsNumber(m[1]) : null;
      }

      // ===== Parseo de un bloque =====
      function extractFromBlock({pre, post, isin}){
        const titMatchAll = pre.match(/([0-9][\d\.,]*)\s*t[íi]t\.?/gi);
        let titulos = null, lastTitNum = null;
        if (titMatchAll && titMatchAll.length){
          const last=titMatchAll[titMatchAll.length-1];
          const numM=/([0-9][\d\.,]*)/i.exec(last);
          titulos = numM ? parseEsNumber(numM[1]) : null;
          lastTitNum = numM ? numM[1] : null;
          if (titulos!=null && titulos>=1000000) titulos=null;
        }
        const nombreRaw = (lastTitNum!=null)
          ? pre.slice(pre.lastIndexOf(lastTitNum) + lastTitNum.length)
          : pre.split(/\n/).slice(-5).join('\n');
        const nombre = cleanNameBlock(nombreRaw);

        const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
        const precio = precioM ? parseEsNumber(precioM[1]) : null;

        let cotizacion_eur = (precio!=null && titulos!=null) ? round2(precio * titulos) : null;
        const eurCercano = extractCotizacionEUR(post);
        if (eurCercano != null && cotizacion_eur != null && Math.abs(eurCercano - cotizacion_eur) <= 1.00) {
          cotizacion_eur = eurCercano;
        }

        return { nombre, isin, titulos, precio_eur: precio, cotizacion_eur };
      }

      // ===== Agregación por ISIN =====
      function aggregateByISIN(rows){
        const map = new Map();
        for (const r of rows){
          const k = r.isin || '';
          if (!map.has(k)){
            map.set(k, { ...r });
          } else {
            const acc = map.get(k);
            const t1 = acc.titulos || 0, t2 = r.titulos || 0;
            const v1 = acc.cotizacion_eur || 0, v2 = r.cotizacion_eur || 0;
            const p1 = acc.precio_eur, p2 = r.precio_eur;

            acc.titulos = (t1 || t2) ? round2(t1 + t2) : (t1 || t2 || null);
            acc.cotizacion_eur = round2(v1 + v2);

            if ((t1 + t2) > 0 && (p1 != null || p2 != null)){
              const w1 = (p1!=null ? p1*t1 : 0), w2 = (p2!=null ? p2*t2 : 0);
              const denom = t1 + t2;
              acc.precio_eur = denom > 0 ? round2((w1 + w2) / denom) : (p1 ?? p2 ?? null);
            } else {
              acc.precio_eur = p1 ?? p2 ?? null;
            }
          }
        }
        return Array.from(map.values());
      }

      // ===== React App =====
      const { useState, useMemo, useEffect } = React;
      function App(){
        const [rows, setRows] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [filter, setFilter] = useState('');
        const [pdfResumen, setPdfResumen] = useState(null);

        // JSON externos
        const [countries, setCountries] = useState(null);   // { "US": "Estados Unidos", ... }
        const [sectors, setSectors]   = useState(null);     // { "US92826C8394": "Pagos/Fintech", ... }
        const [jsonErr, setJsonErr]   = useState('');

        useEffect(() => {
          // Carga country.json y sectores.json desde la misma carpeta
          Promise.all([
            fetch('country.json').then(r => r.ok ? r.json() : Promise.reject('country.json no encontrado')),
            fetch('sectores.json').then(r => r.ok ? r.json() : Promise.reject('sectores.json no encontrado')),
          ]).then(([c,s]) => { setCountries(c); setSectors(s); })
            .catch(e => setJsonErr(String(e)));
        }, []);

        // País por ISIN usando country.json
        const countryFromISIN = (isin) => {
          if (!countries || !isin) return '';
          const m = String(isin).match(/^([A-Z]{2})/);
          const cc = m ? m[1] : null;
          return cc && countries[cc] ? countries[cc] : (cc || '');
        };

        // Sector desde sectores.json (sin heurísticas)
        const sectorFromISIN = (isin) => {
          if (!sectors || !isin) return '';
          return sectors[isin] || '';
        };

        const filtered = useMemo(() => {
          const q=(filter||'').toLowerCase();
          return rows.filter(r =>
            !q ||
            (r.nombre||'').toLowerCase().includes(q) ||
            (r.isin||'').toLowerCase().includes(q) ||
            (r.pais||'').toLowerCase().includes(q) ||
            (r.sector||'').toLowerCase().includes(q)
          );
        }, [rows, filter]);

        const totalValor = useMemo(() => +filtered.reduce((a,r)=>a+(r.cotizacion_eur||0),0).toFixed(2), [filtered]);
        const totalPosiciones = filtered.length;

        async function onFile(file){
          setError(''); setLoading(true);
          try {
            const pdfData=new Uint8Array(await file.arrayBuffer());
            const pdf=await pdfjsLib.getDocument({data:pdfData}).promise;
            let fullText='';
            for(let i=1;i<=pdf.numPages;i++){
              const page=await pdf.getPage(i);
              const content=await page.getTextContent();
              const pageText=content.items.map(it=>it.str).join('\n');
              fullText += '\n' + pageText + '\n';
            }
            const text = fullText.replace(/\u00A0/g,' ').replace(/\s+\n/g,'\n').replace(/\n{2,}/g,'\n');

            // parse + agregar por ISIN
            const parsed = buildBlocks(text).map(extractFromBlock);
            let data = aggregateByISIN(parsed);

            // anotar país y sector usando los JSON cargados (si aún no están, quedarán vacíos hasta que carguen)
            data = data.map(r => ({
              ...r,
              pais: countryFromISIN(r.isin),
              sector: sectorFromISIN(r.isin)
            }));

            // resumen y aviso
            const resumenMatch = text.match(/N[ÚU]MERO\s+DE\s+POSICIONES:\s*(\d+)\s+(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)/i);
            const resumen = resumenMatch ? { count: Number(resumenMatch[1]), total: parseEsNumber(resumenMatch[2]) } : null;

            if (resumen){
              const sum = +data.reduce((a,r)=>a+(r.cotizacion_eur||0),0).toFixed(2);
              if (sum !== +(resumen.total||0).toFixed(2)) {
                setError(`Aviso: el PDF dice ${resumen.count} posiciones y ${fmt(resumen.total)} EUR. Hemos leído ${data.length} y ${fmt(sum)} EUR.`);
              }
            }

            setRows(data); setPdfResumen(resumen);
          } catch(e){
            setError('No se pudo leer el PDF. Asegúrate de subir el extracto original (ES).');
          } finally { setLoading(false); }
        }

        function exportCSV(){
          const csv = Papa.unparse(filtered.map(r => ({
            nombre:r.nombre, isin:r.isin, titulos:r.titulos, precio_eur:r.precio_eur,
            cotizacion_eur:r.cotizacion_eur, sector:r.sector, pais:r.pais
          })), { delimiter:';' });
          const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='cartera_export.csv'; a.click();
          URL.revokeObjectURL(url);
        }

        return React.createElement('div',{className:'max-w-7xl mx-auto p-4 md:p-8 space-y-6'},
          React.createElement('header',{className:'flex items-center justify-between gap-3 flex-wrap'},
            React.createElement('h1',{className:'text-2xl md:text-3xl font-bold'},'Invest · Lector de extractos (v3.22)'),
            React.createElement('div',{className:'flex items-center gap-2'},
              React.createElement('span',{className:'badge bg-slate-100 text-slate-700'},'Posiciones: '+totalPosiciones),
              React.createElement('span',{className:'badge bg-slate-100 text-slate-700'},'Valor: '+fmt(totalValor)+' EUR')
            ),
            React.createElement('div',{className:'flex items-center gap-2 grow md:grow-0'},
              React.createElement('button',{onClick:function(){const el=document.getElementById('file'); if(el) el.click();},className:'px-3 py-2 rounded-xl bg-slate-900 text-white shadow hover:opacity-90'},'Subir PDF'),
              React.createElement('button',{onClick:exportCSV,className:'px-3 py-2 rounded-2xl border shadow bg-white'},'Exportar CSV')
            )
          ),
          React.createElement('section',{className:'grid md:grid-cols-3 gap-4'},
            React.createElement('div',{className:'md:col-span-2 p-4 rounded-2xl bg-white shadow'},
              React.createElement('label',{className:'text-sm text-slate-500'},'Sube tu PDF de Trade Republic (ES):'),
              React.createElement('input',{id:'file',type:'file',accept:'application/pdf',style:{display:'none'},onChange:function(e){ if(e&&e.target&&e.target.files&&e.target.files[0]) onFile(e.target.files[0]); }}),
              (jsonErr && !countries) ? React.createElement('div',{className:'mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded'}, 'No se pudo cargar country.json / sectores.json. Colócalos junto al HTML en tu servidor.'):null,
              loading?React.createElement('div',{className:'mt-4 text-sm text-slate-600'},'Leyendo PDF…'):null,
              error?React.createElement('div',{className:'mt-4 text-sm text-red-600'},error):null,
              pdfResumen?React.createElement('div',{className:'mt-2 text-sm text-slate-500'},'Resumen del PDF: '+pdfResumen.count+' posiciones · '+fmt(pdfResumen.total)+' EUR'):null
            ),
            React.createElement('div',{className:'p-4 rounded-2xl bg-white shadow space-y-3'},
              React.createElement('input',{className:'w-full px-3 py-2 rounded-xl border',placeholder:'Filtrar por nombre, ISIN, sector o país…',value:filter,onChange:function(e){ setFilter(e.target.value); }}),
              React.createElement('div',{className:'text-sm text-slate-500'},'Filas visibles: '+filtered.length),
              React.createElement('div',{className:'text-sm text-slate-500 mono'},'Total posiciones (visibles): '+totalPosiciones),
              React.createElement('div',{className:'text-sm text-slate-500 mono'},'Total valor (visibles): '+fmt(totalValor)+' EUR')
            )
          ),
          React.createElement('section',{className:'overflow-auto rounded-2xl bg-white shadow'},
            React.createElement('table',{className:'min-w-full text-sm'},
              React.createElement('thead',null,
                React.createElement('tr',null,['Nombre','ISIN','Títulos','Precio EUR','Cotización EUR','Sector','País'].map(h =>
                  React.createElement('th',{key:h,className:'px-3 py-2 text-left font-semibold text-slate-600'},h)
                ))
              ),
              React.createElement('tbody',null,
                filtered.map((r,idx) =>
                  React.createElement('tr',{key:String(idx),className:(idx%2?'bg-slate-50':'')},
                    React.createElement('td',{className:'px-3 py-2'},r.nombre||''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.isin||''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.titulos!=null?r.titulos:''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.precio_eur!=null?fmt(r.precio_eur):''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.cotizacion_eur!=null?fmt(r.cotizacion_eur):''),
                    React.createElement('td',{className:'px-3 py-2'},r.sector||''),
                    React.createElement('td',{className:'px-3 py-2'},r.pais||'')
                  )
                )
              ),
              React.createElement('tfoot',null,
                React.createElement('tr',{className:'bg-slate-100 font-semibold'},
                  React.createElement('td',{className:'px-3 py-2',colSpan:2},'Totales (visibles)'),
                  React.createElement('td',{className:'px-3 py-2 mono'},totalPosiciones),
                  React.createElement('td',{className:'px-3 py-2 mono'}),
                  React.createElement('td',{className:'px-3 py-2 mono'},fmt(totalValor)),
                  React.createElement('td',{className:'px-3 py-2'}),
                  React.createElement('td',{className:'px-3 py-2'})
                )
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
