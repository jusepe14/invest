<!-- public/index.html — v3.4.3 (headers (€), Peso sin %, tablas Sector/Región sin título, Región=EEUU/Europa/Asia/Otros, papelera roja) -->
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invest | Lector PDF cartera (v3.4.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        .mono {
            font-variant-numeric: tabular-nums;
        }

        /* Botones y tarjetas */
        .btn {
            padding: .5rem .75rem;
            border-radius: .75rem;
            border: 1px solid #cbd5e1;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,.05);
        }

        .btn-primary {
            padding: .5rem .75rem;
            border-radius: .75rem;
            background: #0f172a;
            color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,.15);
        }

        .btn-danger {
            padding: .5rem .75rem;
            border-radius: .75rem;
            background: #b91c1c;
            color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,.15);
        }

        .card {
            background: #fff;
            border-radius: 1.25rem;
            box-shadow: 0 8px 30px rgba(15,23,42,.06);
            border: 1px solid rgba(148,163,184,.2);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .125rem .5rem;
            border-radius: .5rem;
            font-size: .75rem;
            background: #f1f5f9;
        }

        table thead th {
            position: sticky;
            top: 0;
            background: #f1f5f9;
            cursor: pointer;
            user-select: none;
        }

        .th-static {
            cursor: default !important;
        }

        /* Modal base */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgb(15 23 42 / .4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-card {
            width: 100%;
            max-width: 860px;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #fff;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1rem 1.25rem;
            overflow: auto;
            flex: 1 1 auto;
        }

        .modal-footer {
            position: sticky;
            bottom: 0;
            z-index: 1;
            background: #fff;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: .5rem;
            justify-content: flex-end;
        }

        .input {
            width: 100%;
            padding: .5rem .75rem;
            border: 1px solid #cbd5e1;
            border-radius: .75rem;
        }

            .input:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(100,116,139,.2);
                border-color: #94a3b8;
            }

        .label {
            font-size: .8rem;
            color: #475569;
        }

        .help {
            font-size: .75rem;
            color: #64748b;
        }

        .err {
            font-size: .75rem;
            color: #b91c1c;
            margin-top: .25rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .75rem;
        }

        /* Charts */
        .chart-wrap {
            position: relative;
            width: 100%;
            max-width: 520px;
            margin-inline: auto;
        }

        .chart-canvas {
            width: 100%;
            aspect-ratio: 1/1;
            display: block;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem 1rem;
            justify-content: center;
            margin-top: .5rem;
            row-gap: .25rem;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            font-size: .85rem;
            color: #0f172a;
        }

        .chip-dot {
            width: .75rem;
            height: .75rem;
            border-radius: 999px;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px rgba(15,23,42,.1) inset;
        }

        .chip-flag {
            width: 18px;
            height: 12px;
            object-fit: cover;
            border-radius: 3px;
            box-shadow: 0 0 0 1px rgba(15,23,42,.1) inset;
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            background: #fff;
            color: #0f172a;
            border-radius: .75rem;
            padding: .5rem .65rem;
            box-shadow: 0 10px 30px rgba(15,23,42,.15);
            border: 1px solid rgba(148,163,184,.25);
            min-width: 140px;
        }

            .tooltip h4 {
                margin: 0 0 .15rem 0;
                font-weight: 600;
            }

            .tooltip small {
                color: #475569;
            }

        /* Igualar alturas de tarjetas de análisis */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 900px) {
            .analysis-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .analysis-card {
            min-height: 520px;
            display: flex;
            flex-direction: column;
        }

        .analysis-body {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: .5rem;
            flex: 1 1 auto;
        }

        .analysis-footer {
            margin-top: auto;
            padding: .75rem 1.25rem 1rem;
        }

        /* Tabla acciones */
        .row-actions {
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .icon-btn {
            padding: .4rem;
            border-radius: .5rem;
            border: 1px solid #cbd5e1;
            background: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            .icon-btn:hover {
                background: #f8fafc;
            }

        .icon-circle {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }

            .icon-circle:hover {
                background: #f8fafc;
            }

        /* Papelera roja (icono) */
        .icon-danger {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #ef4444;
            color: #ef4444;
            background: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }

            .icon-danger:hover {
                background: #fff0f0;
            }

        /* Indicador orden */
        .sort-ind {
            font-size: .8em;
            opacity: .7;
            margin-left: .25rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script>
        'use strict';

        /* ========================= Utilidades base ========================= */
        const REQUIRE_ISIN = false;
        const parseEsNumber = (s) => { if (s == null) return null; s = ('' + s).replace(/\./g, '').replace(/,/g, '.').replace(/\s/g, ''); const v = Number(s); return Number.isFinite(v) ? v : null; };
        const fmt = (n) => n != null ? n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
        const fmt0 = (n) => n != null ? n.toLocaleString('es-ES') : '';
        const fmt1p = (n) => n != null ? n.toLocaleString('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) : '';
        const round2 = (n) => n == null ? null : +(Math.round(n * 100) / 100).toFixed(2);
        const isISIN = v => /^[A-Z]{2}[A-Z0-9]{9}\d$/.test(String(v || '').toUpperCase());
        const isLikelyTicker = v => /^[A-Z][A-Z0-9.\-]{0,6}$/.test(String(v || '').trim()) && !isISIN(v);
        const normAng = a => { let x = a % (2 * Math.PI); if (x < 0) x += 2 * Math.PI; return x; };
        const angBetween = (theta, a0, a1) => {
            const t = normAng(theta), A0 = normAng(a0), A1 = normAng(a1);
            return (A0 <= A1) ? (t >= A0 && t <= A1) : (t >= A0 || t <= A1);
        };

        // Paleta con alto contraste
        const PALETTE = ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1', '#ff9da7', '#9c755f', '#bab0ab'];

        function cleanNameBlock(block) {
            if (!block) return '';
            let lines = String(block).split(/\n+/).map(s => s.replace(/\s{2,}/g, ' ').trim()).filter(Boolean);
            const headerRe = /(VALOR NOMINAL|NOMBRE DEL VALOR|PRECIO POR T[ÍI]TULO|COTIZACI[ÓO]N EN EUR|PA[ÍI]S DE CUSTODIA|TRADE REPUBLIC|EXTRACTO|CUENTA DE VALORES|RESUMEN|IBAN|BIC|DEP[ÓO]SITO)/i;
            lines = lines.filter(l => !headerRe.test(l) && !/t[íi]t\.?/i.test(l));
            if (!lines.length) return '';
            let line = lines[0];
            line = line.replace(/^\d[\d\.,]*\s*t[íi]t\.?\s*/i, '');
            line = line.split(/ISIN\s*:/i)[0].trim();
            const qual = /\b(Registered|Actions?|Acciones?|Shares?|Shs|ADR|ADS|Ord\.?|Bearer|Nominative|EO\b|DL\b|Class|Serie|Series|Port\.?|Nominal)\b/i;
            const qm = qual.exec(line); if (qm) line = line.slice(0, qm.index).trim();
            line = line.replace(/[·•\-–—,:;]+$/, '').trim();
            return line;
        }

        function buildBlocks(text) {
            const re = /ISIN\s*:?[^A-Z0-9]*([A-Z0-9]{12})/gi;
            const matches = []; let m;
            while ((m = re.exec(text)) !== null) matches.push({ start: m.index, isin: m[1].toUpperCase() });
            const blocks = [];
            for (let i = 0; i < matches.length; i++) {
                const cur = matches[i];
                const nextStart = (i + 1 < matches.length) ? matches[i + 1].start : text.length;
                const pre = text.slice(Math.max(0, cur.start - 600), cur.start);
                let post = text.slice(cur.start, nextStart);
                if (i === matches.length - 1) {
                    post = post.replace(/N[ÚU]MERO\s+DE\s+POSICIONES[\s\S]*$/i, '');
                    post = post.replace(/RESUMEN[\s\S]*$/i, '');
                    post = post.replace(/TOTAL[\s\S]*$/i, '');
                }
                blocks.push({ pre, post, isin: cur.isin });
            }
            return blocks;
        }

        function extractCotizacionEUR(post) {
            const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
            if (!precioM) return null;
            const start = precioM.index + precioM[0].length;
            const ventana = post.slice(start, start + 200);
            const m = ventana.match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2}))\s*EUR/i);
            return m ? parseEsNumber(m[1]) : null;
        }

        function extractFromBlock({ pre, post, isin }) {
            const titMatchAll = pre.match(/([0-9][\d\.,]*)\s*t[íi]t\.?/gi);
            let titulos = null, lastTitNum = null;
            if (titMatchAll && titMatchAll.length) {
                const last = titMatchAll[titMatchAll.length - 1];
                const numM = /([0-9][\d\.,]*)/i.exec(last);
                titulos = numM ? parseEsNumber(numM[1]) : null;
                lastTitNum = numM ? numM[1] : null;
                if (titulos != null && titulos >= 1000000) titulos = null;
            }
            const nombreRaw = (lastTitNum != null) ? pre.slice(pre.lastIndexOf(lastTitNum) + lastTitNum.length) : pre.split(/\n/).slice(-5).join('\n');
            const nombre = cleanNameBlock(nombreRaw);

            const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
            const precio = precioM ? parseEsNumber(precioM[1]) : null;

            let cotizacion_eur = (precio != null && titulos != null) ? round2(precio * titulos) : null;
            const eurCercano = extractCotizacionEUR(post);
            if (eurCercano != null && cotizacion_eur != null && Math.abs(eurCercano - cotizacion_eur) <= 1.00) {
                cotizacion_eur = eurCercano;
            }
            return { nombre, isin, titulos, precio_eur: precio, cotizacion_eur };
        }

        function aggregateByISIN(rows) {
            const map = new Map();
            for (const r of rows) {
                const k = r.isin || '';
                if (!map.has(k)) {
                    map.set(k, { ...r });
                } else {
                    const acc = map.get(k);
                    const t1 = acc.titulos || 0, t2 = r.titulos || 0;
                    const v1 = acc.cotizacion_eur || 0, v2 = r.cotizacion_eur || 0;
                    const p1 = acc.precio_eur, p2 = r.precio_eur;
                    acc.titulos = (t1 || t2) ? round2(t1 + t2) : (t1 || t2 || null);
                    acc.cotizacion_eur = round2(v1 + v2);
                    if ((t1 + t2) > 0 && (p1 != null || p2 != null)) {
                        const w1 = (p1 != null ? p1 * t1 : 0), w2 = (p2 != null ? p2 * t2 : 0);
                        const denom = t1 + t2;
                        acc.precio_eur = denom > 0 ? round2((w1 + w2) / denom) : (p1 ?? p2 ?? null);
                    } else {
                        acc.precio_eur = p1 ?? p2 ?? null;
                    }
                }
            }
            return Array.from(map.values());
        }

        function reconcileToPdfTotal(rows, pdfTotal) {
            if (!rows || !rows.length || pdfTotal == null) return rows;
            const target = +(+pdfTotal).toFixed(2);
            let sum = +rows.reduce((a, r) => a + (r.cotizacion_eur || 0), 0).toFixed(2);
            const delta = +(target - sum).toFixed(2);
            if (delta === 0) return rows;
            let idxMax = -1, maxVal = -Infinity;
            for (let i = 0; i < rows.length; i++) {
                const v = rows[i].cotizacion_eur ?? -Infinity;
                if (v > maxVal) { maxVal = v; idxMax = i; }
            }
            if (idxMax >= 0) {
                rows[idxMax] = { ...rows[idxMax], cotizacion_eur: round2((rows[idxMax].cotizacion_eur || 0) + delta) };
            }
            return rows;
        }

        // ===== Aux backend =====
        async function resolveInstrument(q) {
            const r = await fetch(`/api/resolve?q=${encodeURIComponent(q)}`, { cache: 'no-store' });
            const j = await r.json();
            if (!r.ok) throw new Error(j?.error || 'resolve error');
            return { name: j.name || '', isin: j.isin || '', ticker: j.ticker || '' };
        }

        const { useState, useMemo, useEffect, useRef } = React;

        async function resolveISINStrict(q, nameHint, fetchPriceEURFn) {
            const base = String(q || '').trim().toUpperCase();
            const attempts = [];
            if (base) {
                attempts.push(base);
                if (isLikelyTicker(base)) attempts.push(`${base} US`, `${base} USA`, `${base} NASDAQ`, `${base} NYSE`);
            }
            if (nameHint && nameHint.trim()) attempts.push(nameHint.trim());
            let quoteName = '';
            if (!nameHint && base) {
                try {
                    const qi = await fetchPriceEURFn(base);
                    quoteName = qi?.name || '';
                    if (quoteName) attempts.push(quoteName);
                } catch { }
            }
            for (const a of attempts) {
                try {
                    const info = await resolveInstrument(a);
                    if (info?.isin && isISIN(info.isin))
                        return { isin: String(info.isin).toUpperCase(), name: info.name || nameHint || quoteName || '' };
                } catch { }
            }
            return { isin: '', name: nameHint || quoteName || '' };
        }

        /* ========================= App ========================= */
        function App() {
            const [rows, setRows] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [filter, setFilter] = useState('');
            const [pdfResumen, setPdfResumen] = useState(null);

            const [countries, setCountries] = useState(null);
            const [sectors, setSectors] = useState(null);
            const [jsonErr, setJsonErr] = useState('');

            const [modalOpen, setModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('add'); // 'add' | 'edit'
            const initialForm = { tickerOrIsin: '', isin: '', titulos: '', nameResolved: '', sector: '', pais: '' };
            const [form, setForm] = useState(initialForm);
            const [formErrors, setFormErrors] = useState({});
            const [editKey, setEditKey] = useState(null);

            // Detalle por porción
            const [detailOpen, setDetailOpen] = useState(false);
            const [detailData, setDetailData] = useState({ type: '', label: '', items: [], total: 0 });

            const resolveDebounceRef = useRef(null);

            // --- Análisis
            const [showAnalysis, setShowAnalysis] = useState(true);
            const sectorCanvasRef = useRef(null);
            const regionCanvasRef = useRef(null);
            const sectorTooltipRef = useRef(null);
            const regionTooltipRef = useRef(null);

            // anchor para scroll al análisis
            const analysisSectionRef = useRef(null);

            // Flags (Asia usa cn.png ya definido por ti)
            const flagImgsRef = useRef({});
            const flagPaths = { EEUU: 'flags/us.png', Europa: 'flags/eu.png', Asia: 'flags/cn.png' };

            // Ordenación
            const [sortKey, setSortKey] = useState('cotizacion_eur');
            const [sortDir, setSortDir] = useState('desc'); // 'asc' | 'desc'

            /* ---- Carga de JSON y de cartera local ---- */
            useEffect(() => {
                Promise.all([
                    fetch('country.json').then(r => r.ok ? r.json() : Promise.reject('country.json no encontrado')),
                    fetch('sectores.json').then(r => r.ok ? r.json() : Promise.reject('sectores.json no encontrado')),
                ]).then(([c, s]) => { setCountries(c); setSectors(s); })
                    .catch(e => setJsonErr(String(e)));
                try {
                    const saved = localStorage.getItem('carteraRows');
                    if (saved) {
                        const arr = JSON.parse(saved);
                        if (Array.isArray(arr)) setRows(arr);
                    }
                } catch { }
            }, []);

            const countryFromISIN = (isin) => {
                if (!countries || !isin) return '';
                const m = String(isin).match(/^([A-Z]{2})/);
                const cc = m ? m[1] : null;
                if (cc === 'KY') return 'China';
                return cc && countries[cc] ? countries[cc] : (cc || '');
            };
            const sectorFromISIN = (isin) => {
                if (!sectors || !isin) return '';
                return sectors[isin] || '';
            };

            function getSectorOptions() {
                if (!sectors) return [];
                const vals = Object.values(sectors);
                const uniq = Array.from(new Set(vals.filter(v => typeof v === 'string' && String(v).trim())));
                return uniq.sort();
            }

            function resolveCountryInput(input) {
                if (!countries) return null;
                const raw = String(input || '').trim();
                if (!raw) return '';
                const code = raw.toUpperCase();
                if (/^[A-Z]{2}$/.test(code)) {
                    if (code === 'KY') return 'China';
                    if (countries[code]) return countries[code];
                }
                const vals = Object.values(countries);
                const hit = vals.find(v => String(v).toLowerCase() === raw.toLowerCase());
                if (!hit && raw.toLowerCase() === 'ky') return 'China';
                return hit || null;
            }

            const filtered = useMemo(() => {
                const q = (filter || '').toLowerCase();
                return rows.filter(r =>
                    !q ||
                    (r.nombre || '').toLowerCase().includes(q) ||
                    (r.isin || '').toLowerCase().includes(q) ||
                    (r.pais || '').toLowerCase().includes(q) ||
                    (r.sector || '').toLowerCase().includes(q)
                );
            }, [rows, filter]);

            const totalAll = useMemo(() => +rows.reduce((a, r) => a + (r.cotizacion_eur || 0), 0).toFixed(2), [rows]);

            // Peso (%) de cada fila respecto al total de la cartera
            const withPeso = useMemo(() => {
                return filtered.map(r => {
                    const peso = totalAll > 0 && r.cotizacion_eur != null ? (r.cotizacion_eur / totalAll * 100) : null;
                    return { ...r, peso };
                });
            }, [filtered, totalAll]);

            // Ordenación
            const collators = new Intl.Collator('es', { sensitivity: 'base' });
            function sortRows(arr) {
                const key = sortKey;
                const dir = sortDir === 'asc' ? 1 : -1;
                return [...arr].sort((a, b) => {
                    const A = a[key], B = b[key];
                    const isNum = ['titulos', 'precio_eur', 'cotizacion_eur', 'peso'].includes(key);
                    if (isNum) {
                        const nA = (A == null ? -Infinity : Number(A));
                        const nB = (B == null ? -Infinity : Number(B));
                        return (nA < nB ? -1 : nA > nB ? 1 : 0) * dir;
                    } else {
                        const sA = String(A || ''); const sB = String(B || '');
                        return collators.compare(sA, sB) * dir;
                    }
                });
            }
            const displayRows = useMemo(() => sortRows(withPeso), [withPeso, sortKey, sortDir]);

            const totalValorVisible = useMemo(() => +displayRows.reduce((a, r) => a + (r.cotizacion_eur || 0), 0).toFixed(2), [displayRows]);
            const totalPosiciones = displayRows.length;

            async function onFile(file) {
                setError(''); setLoading(true);
                try {
                    const pdfData = new Uint8Array(await file.arrayBuffer());
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const pageText = content.items.map(it => it.str).join('\n');
                        fullText += '\n' + pageText + '\n';
                    }
                    const text = fullText.replace(/\u00A0/g, ' ').replace(/\s+\n/g, '\n').replace(/\n{2,}/g, '\n');
                    let data = aggregateByISIN(buildBlocks(text).map(extractFromBlock));
                    data = data.map(r => ({
                        ...r,
                        pais: r.pais || countryFromISIN(r.isin),
                        sector: r.sector || sectorFromISIN(r.isin)
                    }));
                    const resumenMatch = text.match(/N[ÚU]MERO\s+DE\s+POSICIONES:\s*(\d+)\s*(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)/i);
                    const resumen = resumenMatch ? { count: Number(resumenMatch[1]), total: parseEsNumber(resumenMatch[2]) } : null;
                    if (resumen && resumen.total != null) data = reconcileToPdfTotal(data, resumen.total);
                    setRows(data);
                    setPdfResumen(resumen);
                } catch (e) {
                    setError('No se pudo leer el PDF. Asegúrate de subir el extracto original (ES).');
                } finally { setLoading(false); }
            }

            function exportCSV() {
                // CSV con BOM para tildes correctas en Excel
                const rowsForCsv = displayRows.map(r => ({
                    nombre: r.nombre, isin: r.isin, titulos: r.titulos,
                    precio: r.precio_eur, cotizacion: r.cotizacion_eur,
                    sector: r.sector, pais: r.pais,
                    peso_pct: r.peso != null ? +r.peso.toFixed(2) : null
                }));
                const csvCore = Papa.unparse(rowsForCsv, { delimiter: ';' });
                const csv = '\uFEFF' + csvCore; // BOM
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'cartera_export.csv'; a.click();
                URL.revokeObjectURL(url);
            }

            function saveLocal() {
                try {
                    localStorage.setItem('carteraRows', JSON.stringify(rows));
                    alert('Cartera guardada localmente.');
                } catch (e) {
                    alert('No se pudo guardar localmente.');
                }
            }

            function clearAll() {
                if (confirm('¿Borrar todas las posiciones? Esta acción no se puede deshacer.')) {
                    setRows([]);
                    try { localStorage.removeItem('carteraRows'); } catch { }
                }
            }

            // Precio USD + conversión a EUR
            async function fetchPriceEUR(q) {
                const r = await fetch(`/api/quote_usd?q=${encodeURIComponent(q)}`, { cache: 'no-store' });
                const j = await r.json();
                if (!r.ok || j?.price_usd == null) throw new Error(j?.error || 'quote_usd error');
                const rf = await fetch(`/api/fx?from=USD&to=EUR`, { cache: 'no-store' });
                const jf = await rf.json();
                if (!rf.ok || !Number.isFinite(jf?.rate) || jf.rate <= 0 || jf.rate >= 10) throw new Error('fx USD->EUR no disponible');
                return { price_eur: round2(Number(j.price_usd) * Number(jf.rate)), name: j.name || q, resolvedSymbol: j.symbol || q };
            }

            // Alta/Edición
            function openAddModal() { setModalMode('add'); setEditKey(null); setForm(initialForm); setFormErrors({}); setModalOpen(true); }
            function openEditModal(isin) {
                const r = rows.find(x => x.isin === isin); if (!r) return;
                setModalMode('edit'); setEditKey(isin);
                setForm({ tickerOrIsin: r.ticker || r.isin || '', isin: r.isin || '', titulos: r.titulos ?? '', nameResolved: r.nombre || '', sector: r.sector || '', pais: r.pais || '' });
                setFormErrors({}); setModalOpen(true);
            }
            function closeModal() { setModalOpen(false); setForm(initialForm); setFormErrors({}); setEditKey(null); }

            function validateFormSimple(payload) {
                const errs = {};
                if (!payload.q || !payload.q.trim()) errs.q = 'Obligatorio (ticker o ISIN)';
                if (REQUIRE_ISIN && !payload.isin) errs.isin = 'ISIN obligatorio';
                if (payload.isin && !isISIN(payload.isin)) errs.isin = 'ISIN inválido';
                if (!Number.isFinite(payload.titulos)) errs.titulos = 'Número válido requerido';
                return errs;
            }

            async function tryResolveFromTickerOrIsin() {
                const q = String(form.tickerOrIsin || '').trim().toUpperCase();
                if (!q) return;
                try {
                    let info = await resolveInstrument(q);
                    let foundIsin = info?.isin && isISIN(info.isin) ? String(info.isin).toUpperCase() : '';
                    if (!foundIsin) {
                        const strict = await resolveISINStrict(q, form.nameResolved, fetchPriceEUR);
                        foundIsin = strict.isin || '';
                        if (strict.name && !form.nameResolved) setForm(f => ({ ...f, nameResolved: strict.name }));
                    }
                    if (foundIsin) setForm(f => ({ ...f, isin: foundIsin, nameResolved: info.name || f.nameResolved }));
                    else if (info?.name && !form.nameResolved) setForm(f => ({ ...f, nameResolved: info.name }));
                } catch (e) { console.warn('resolve fail', e?.message || e); }
            }
            async function tryResolveFromExplicitIsin() {
                const q = String(form.isin || '').trim();
                if (!isISIN(q)) return;
                try { const info = await resolveInstrument(q); setForm(f => ({ ...f, nameResolved: info.name || f.nameResolved })); }
                catch (e) { console.warn('resolve fail', e?.message || e); }
            }
            useEffect(() => {
                const q = String(form.tickerOrIsin || '').trim();
                if (resolveDebounceRef.current) clearTimeout(resolveDebounceRef.current);
                if (!q) return;
                resolveDebounceRef.current = setTimeout(() => { tryResolveFromTickerOrIsin(); }, 400);
                return () => { if (resolveDebounceRef.current) clearTimeout(resolveDebounceRef.current); };
            }, [form.tickerOrIsin]);

            async function saveModal() {
                const qInput = String(form.tickerOrIsin || '').trim().toUpperCase();
                const titulos = parseEsNumber(form.titulos);
                let maybeISIN = String(form.isin || '').trim().toUpperCase();
                const errs = validateFormSimple({ q: qInput, isin: maybeISIN, titulos }); setFormErrors(errs);
                if (Object.keys(errs).length) return;

                if (!isISIN(maybeISIN) && qInput) {
                    const strict = await resolveISINStrict(qInput, form.nameResolved, fetchPriceEUR);
                    if (strict.isin) { maybeISIN = strict.isin; setForm(f => ({ ...f, isin: maybeISIN, nameResolved: strict.name || f.nameResolved })); }
                }
                if (REQUIRE_ISIN && !isISIN(maybeISIN)) { setFormErrors(prev => ({ ...prev, isin: 'ISIN obligatorio' })); return; }

                let precio_eur = null, nombre = (form.nameResolved || qInput), resolvedSymbol = '';
                try {
                    const info = await fetchPriceEUR(qInput);
                    precio_eur = info.price_eur; resolvedSymbol = info.resolvedSymbol || '';
                    if (!form.nameResolved && info.name) nombre = info.name;
                } catch (e) { alert('No se pudo obtener el precio USD/EUR ahora mismo.\n\nDetalle: ' + (e?.message || '')); }

                const finalISIN = isISIN(maybeISIN) ? maybeISIN : '';
                let finalPais = ''; const inputPais = String(form.pais || '').trim();
                if (inputPais) {
                    const normalized = resolveCountryInput(inputPais);
                    if (normalized === null) { setFormErrors(prev => ({ ...prev, pais: 'País no válido. Debe existir en country.json (código 2 letras o nombre exacto).' })); return; }
                    finalPais = normalized;
                } else {
                    finalPais = finalISIN ? countryFromISIN(finalISIN) : '';
                }
                const finalSector = String(form.sector || '').trim() || (finalISIN ? sectorFromISIN(finalISIN) : '');

                const row = {
                    nombre: nombre || qInput,
                    isin: finalISIN,
                    titulos,
                    precio_eur,
                    cotizacion_eur: (precio_eur != null && Number.isFinite(titulos)) ? round2(precio_eur * titulos) : null,
                    sector: finalSector,
                    pais: finalPais,
                    ticker: resolvedSymbol || (isLikelyTicker(qInput) ? qInput.toUpperCase() : '')
                };

                if (modalMode === 'add') {
                    const next = finalISIN ? aggregateByISIN([...rows, row]) : [...rows, row];
                    setRows(next);
                } else {
                    const next = rows.map(r => r.isin === editKey ? row : r);
                    setRows(finalISIN ? aggregateByISIN(next) : next);
                }
                closeModal();
            }

            function deleteRow(isin) {
                setRows(rows.filter(x => x.isin !== isin));
            }

            /* ========================= Análisis: agregaciones ========================= */
            const sectorAgg = useMemo(() => {
                const m = new Map();
                for (const r of rows) {
                    const k = (r.sector && r.sector.trim()) ? r.sector.trim() : 'Sin sector';
                    const v = r.cotizacion_eur || 0;
                    m.set(k, (m.get(k) || 0) + v);
                }
                const arr = Array.from(m.entries()).map(([k, v]) => ({ label: k, value: v }));
                arr.sort((a, b) => b.value - a.value);
                return arr;
            }, [rows]);

            // Regiones para donuts (Asia agrupa CN, y "Otros" se agrupa)
            const EU_CODES = new Set(['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE', 'IS', 'LI', 'NO', 'CH', 'GB']);
            const ASIA_CODES = new Set(['AE', 'SA', 'QA', 'KW', 'OM', 'BH', 'IL', 'TR', 'IN', 'ID', 'JP', 'KR', 'SG', 'MY', 'TH', 'VN', 'HK', 'MO', 'TW', 'PH', 'CN']);
            function guessCountryNameOrCode(r) {
                const cc = (r.isin || '').slice(0, 2).toUpperCase();
                if (cc === 'KY') return { code: 'CN', name: 'China' };
                if (/^[A-Z]{2}$/.test(cc)) return { code: cc, name: countries && countries[cc] ? countries[cc] : cc };
                return { code: '', name: (r.pais || '') };
            }
            function regionBucket(r) {
                const { code, name } = guessCountryNameOrCode(r);
                if (code === 'US' || /united states|estados unidos|eeuu|usa/i.test(name)) return 'EEUU';
                if (code && EU_CODES.has(code)) return 'Europa';
                if (code && (ASIA_CODES.has(code))) return 'Asia';
                if (/china|jap|korea|india|singap|taiwan|hong kong|vietnam|saudi|emir|qatar|malaysia|thail/i.test((name || '').toLowerCase())) return 'Asia';
                if (/france|españa|germany|italy|portugal|poland|sweden|norway|switzerland|belgium|netherlands|austria|ireland|greece|uk|united kingdom/i.test((name || '').toLowerCase())) return 'Europa';
                return 'Otros';
            }

            const regionAgg = useMemo(() => {
                const m = new Map();
                for (const r of rows) {
                    const k = regionBucket(r);
                    const v = r.cotizacion_eur || 0;
                    m.set(k, (m.get(k) || 0) + v);
                }
                const order = ['EEUU', 'Europa', 'Asia', 'Otros'];
                const arr = Array.from(m.entries()).map(([k, v]) => ({ label: k, value: v }));
                arr.sort((a, b) => {
                    const ia = order.indexOf(a.label), ib = order.indexOf(b.label);
                    return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
                });
                return arr;
            }, [rows]);

            /* -------- Tablas bajo análisis -------- */

            // Tabla Sector: % y €
            const sectorTable = useMemo(() => {
                const total = totalAll || 1;
                return sectorAgg.map(s => ({
                    label: s.label,
                    value: s.value,
                    pct: (s.value / totalAll * 100) || 0
                })).sort((a, b) => b.value - a.value);
            }, [sectorAgg, totalAll]);

            // Tabla Región: EEUU, Europa, Asia, Otros (agregado)
            const regionTable = useMemo(() => {
                const total = totalAll || 1;
                const map = new Map([['EEUU', 0], ['Europa', 0], ['Asia', 0], ['Otros', 0]]);
                for (const r of rows) {
                    const b = regionBucket(r);
                    const v = r.cotizacion_eur || 0;
                    map.set(b, (map.get(b) || 0) + v);
                }
                const entries = Array.from(map.entries()).map(([label, value]) => ({ label, value, pct: (value / total * 100) || 0 }));
                const order = ['EEUU', 'Europa', 'Asia', 'Otros'];
                entries.sort((a, b) => order.indexOf(a.label) - order.indexOf(b.label));
                return entries;
            }, [rows, totalAll]);

            /* ========================= Detalle por porción ========================= */
            function openDetail(type, label) {
                let items = [];
                if (type === 'sector') {
                    const total = sectorAgg.find(x => x.label === label)?.value || 0;
                    items = rows.filter(r => (r.sector || 'Sin sector') === label).map(r => {
                        const peso = total > 0 && r.cotizacion_eur != null ? (r.cotizacion_eur / total * 100) : null;
                        return { ...r, pesoGrupo: peso };
                    }).sort((a, b) => (b.cotizacion_eur || 0) - (a.cotizacion_eur || 0));
                    setDetailData({ type, label, total, items });
                } else {
                    const total = regionAgg.find(x => x.label === label)?.value || 0;
                    items = rows.filter(r => regionBucket(r) === label).map(r => {
                        const peso = total > 0 && r.cotizacion_eur != null ? (r.cotizacion_eur / total * 100) : null;
                        return { ...r, pesoGrupo: peso };
                    }).sort((a, b) => (b.cotizacion_eur || 0) - (a.cotizacion_eur || 0));
                    setDetailData({ type, label, total, items });
                }
                setDetailOpen(true);
            }

            /* ========================= Análisis: render donuts ========================= */

            function ensureFlagsLoaded() {
                return new Promise(resolve => {
                    const want = ['EEUU', 'Europa', 'Asia'];
                    let pending = 0, started = false;
                    want.forEach(k => {
                        if (flagImgsRef.current[k]) return;
                        const src = flagPaths[k];
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => { flagImgsRef.current[k] = img; done(); };
                        img.onerror = () => { flagImgsRef.current[k] = null; done(); };
                        pending++; started = true; img.src = src;
                    });
                    function done() { if (--pending <= 0) resolve(); }
                    if (!started) resolve();
                });
            }

            function setupHiDPI(canvas) {
                const dpr = Math.max(1, window.devicePixelRatio || 1);
                const cssSize = canvas.clientWidth;
                canvas.width = Math.round(cssSize * dpr);
                canvas.height = Math.round(cssSize * dpr);
                const ctx = canvas.getContext('2d');
                ctx.resetTransform && ctx.resetTransform();
                ctx.scale(dpr, dpr);
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                return { ctx, size: cssSize, dpr };
            }

            // Donut a color (Sector)
            function drawDonutColored(canvas, data, tooltipEl) {
                if (!canvas) return;
                const { ctx, size } = setupHiDPI(canvas);
                ctx.clearRect(0, 0, size, size);
                const cx = size / 2, cy = size / 2;
                const outerR = size * 0.42, innerR = size * 0.24;
                const gap = 0.004 * Math.PI;
                const halfGap = gap / 2;
                const total = data.reduce((a, d) => a + d.value, 0) || 1;

                const segments = [];
                let ang = -Math.PI / 2;
                data.forEach((d, i) => {
                    const frac = (d.value / total);
                    const a0 = ang + halfGap, a1 = ang + frac * 2 * Math.PI - halfGap;
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, outerR, a0, a1);
                    ctx.lineTo(cx + innerR * Math.cos(a1), cy + innerR * Math.sin(a1));
                    ctx.arc(cx, cy, innerR, a1, a0, true);
                    ctx.closePath();
                    ctx.fillStyle = PALETTE[i % PALETTE.length];
                    ctx.fill();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#fff';
                    ctx.stroke();

                    segments.push({ a0, a1, label: d.label, value: d.value });
                    ang = a1 + gap;
                });

                function pickSegment(evt) {
                    const rect = canvas.getBoundingClientRect();
                    const x = evt.clientX - rect.left, y = evt.clientY - rect.top;
                    const dx = x - cx, dy = y - cy;
                    const r = Math.hypot(dx, dy);
                    if (r < innerR || r > outerR) return null;
                    const theta = Math.atan2(dy, dx);
                    for (const s of segments) {
                        if (angBetween(theta, s.a0, s.a1)) return s;
                    }
                    return null;
                }

                function onMove(evt) {
                    const s = pickSegment(evt);
                    if (!s) { tooltipEl.style.display = 'none'; return; }
                    const rect = canvas.getBoundingClientRect();
                    const x = evt.clientX - rect.left, y = evt.clientY - rect.top;
                    const pct = (s.value / total) * 100;
                    tooltipEl.style.display = 'block';
                    tooltipEl.style.left = (x + 16) + 'px';
                    tooltipEl.style.top = (y + 16) + 'px';
                    tooltipEl.innerHTML = `<h4>${s.label}</h4><small>${pct.toFixed(1).replace('.', ',')}% (€${fmt(s.value)})</small>`;
                }
                canvas.onmousemove = onMove;
                canvas.onmouseleave = () => { tooltipEl.style.display = 'none'; };
                canvas.onclick = (evt) => { const s = pickSegment(evt); if (s) openDetail('sector', s.label); };
            }

            // Donut con banderas (Región) — Asia usa cn.png
            function drawDonutFlags(canvas, data, tooltipEl) {
                if (!canvas) return;
                const { ctx, size } = setupHiDPI(canvas);
                ctx.clearRect(0, 0, size, size);
                const cx = size / 2, cy = size / 2;
                const outerR = size * 0.42, innerR = size * 0.24;
                const gap = 0.004 * Math.PI;
                const halfGap = gap / 2;
                const total = data.reduce((a, d) => a + d.value, 0) || 1;

                const segments = [];
                let ang = -Math.PI / 2;
                data.forEach((d) => {
                    const frac = (d.value / total);
                    const a0 = ang + halfGap, a1 = ang + frac * 2 * Math.PI - halfGap;

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, outerR, a0, a1);
                    ctx.lineTo(cx + innerR * Math.cos(a1), cy + innerR * Math.sin(a1));
                    ctx.arc(cx, cy, innerR, a1, a0, true);
                    ctx.closePath();
                    ctx.clip();

                    const key = (d.label === 'Asia') ? 'Asia' : d.label;
                    const img = flagImgsRef.current[key] || null;

                    if (img) {
                        const mid = (a0 + a1) / 2;
                        const THICK = (outerR - innerR);
                        const scale = 1.08;
                        let box = outerR * 2 * scale + THICK * 0.35;
                        const offset = THICK * 1.25;
                        const tangential =
                            d.label === 'Asia' ? 0.20 * THICK :
                                d.label === 'Europa' ? -0.10 * THICK :
                                    d.label === 'EEUU' ? 0.20 * THICK :
                                        0.20 * THICK;
                        const tx = -Math.sin(mid) * tangential;
                        const ty = Math.cos(mid) * tangential;
                        const x = (cx - box / 2) + Math.cos(mid) * offset + tx;
                        const y = (cy - box / 2) + Math.sin(mid) * offset + ty;
                        ctx.globalAlpha = 0.95;
                        ctx.drawImage(img, x, y, box, box);
                        ctx.globalAlpha = 1;
                    } else {
                        ctx.fillStyle = { EEUU: '#9c1236', Europa: '#355aa5', Asia: '#6b7280', Otros: '#f59e0b' }[d.label] || '#94a3b8';
                        ctx.fillRect(cx - outerR, cy - outerR, outerR * 2, outerR * 2);
                    }

                    ctx.restore();
                    ctx.beginPath();
                    ctx.arc(cx, cy, outerR, a0, a1);
                    ctx.arc(cx, cy, innerR, a1, a0, true);
                    ctx.closePath();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#fff';
                    ctx.stroke();

                    segments.push({ a0, a1, label: d.label, value: d.value });
                    ang = a1 + gap;
                });

                function pickSegment(evt) {
                    const rect = canvas.getBoundingClientRect();
                    const x = evt.clientX - rect.left, y = evt.clientY - rect.top;
                    const dx = x - cx, dy = y - cy;
                    const r = Math.hypot(dx, dy);
                    if (r < innerR || r > outerR) return null;
                    const theta = Math.atan2(dy, dx);
                    for (const s of segments) {
                        if (angBetween(theta, s.a0, s.a1)) return s;
                    }
                    return null;
                }

                function onMove(evt) {
                    const s = pickSegment(evt);
                    if (!s) { tooltipEl.style.display = 'none'; return; }
                    const rect = canvas.getBoundingClientRect();
                    const x = evt.clientX - rect.left, y = evt.clientY - rect.top;
                    const pct = (s.value / total) * 100;
                    tooltipEl.style.display = 'block';
                    tooltipEl.style.left = (x + 16) + 'px';
                    tooltipEl.style.top = (y + 16) + 'px';
                    tooltipEl.innerHTML = `<h4>${s.label}</h4><small>${pct.toFixed(1).replace('.', ',')}% (€${fmt(s.value)})</small>`;
                }
                canvas.onmousemove = onMove;
                canvas.onmouseleave = () => { tooltipEl.style.display = 'none'; };
                canvas.onclick = (evt) => { const s = pickSegment(evt); if (s) openDetail('region', s.label); };
            }

            // Redibujar y hacer scroll cuando se muestra análisis
            useEffect(() => {
                if (!showAnalysis) return;
                (async () => {
                    await ensureFlagsLoaded();
                    const sc = sectorCanvasRef.current, rc = regionCanvasRef.current;
                    const stt = sectorTooltipRef.current, rtt = regionTooltipRef.current;
                    if (sc && sectorAgg.length) { drawDonutColored(sc, sectorAgg, stt); }
                    if (rc && regionAgg.length) { drawDonutFlags(rc, regionAgg, rtt); }
                    analysisSectionRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })();
            }, [showAnalysis, sectorAgg, regionAgg]);

            // UI: ordenar
            function onSort(col) {
                if (col === sortKey) {
                    setSortDir(d => d === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortKey(col);
                    setSortDir(col === 'cotizacion_eur' ? 'desc' : 'asc');
                }
            }
            function sortArrow(col) {
                if (col !== sortKey) return '';
                return sortDir === 'asc' ? '▲' : '▼';
            }

            /* ========================= Render ========================= */
            return React.createElement('div', { className: 'max-w-7xl mx-auto p-4 md:p-8 space-y-6' },

                /* -------- Top bar estilo broker -------- */
                React.createElement('header', { className: 'flex items-center justify-between gap-3 flex-wrap' },
                    React.createElement('div', { className: 'flex items-center gap-3 text-sm text-slate-500' },
                        React.createElement('span', null, 'v3.4.3'),
                        React.createElement('span', { className: 'text-slate-900 font-semibold' }, 'Invest'),
                        React.createElement('span', null, '|'),
                        React.createElement('span', null, 'Análisis de Cartera')
                    ),
                    React.createElement('div', { className: 'flex items-center gap-2' },
                        React.createElement('span', { className: 'badge' }, 'Posiciones: ' + totalPosiciones),
                        React.createElement('span', { className: 'badge' }, 'Valor: ' + fmt(totalValorVisible) + ' EUR')
                    )
                ),

                /* -------- Toolbar -------- */
                React.createElement('section', { className: 'card p-4' },
                    React.createElement('div', { className: 'flex flex-col md:flex-row items-stretch md:items-center gap-3' },
                        React.createElement('div', { className: 'flex items-center gap-2' },
                            React.createElement('button', { onClick: () => document.getElementById('file').click(), className: 'btn-primary' }, 'Subir PDF'),
                            React.createElement('input', { id: 'file', type: 'file', accept: 'application/pdf', style: { display: 'none' }, onChange: (e) => { const f = e?.target?.files?.[0]; if (f) onFile(f); } }),
                            React.createElement('button', { onClick: exportCSV, className: 'btn' }, 'Exportar CSV'),
                            React.createElement('button', { onClick: saveLocal, className: 'btn' }, 'Guardar'),
                            React.createElement('button', { onClick: () => setShowAnalysis(s => !s ? true : false), className: 'btn' }, showAnalysis ? 'Ir a análisis' : 'Analizar')
                        ),
                        React.createElement('div', { className: 'grow' }),
                        React.createElement('div', { className: 'w-full md:w-80' },
                            React.createElement('input', { className: 'w-full px-3 py-2 rounded-xl border', placeholder: 'Filtrar por nombre, ISIN, sector o país…', value: filter, onChange: (e) => setFilter(e.target.value) })
                        )
                    ),
                    (jsonErr && (!countries || !sectors)) ? React.createElement('div', { className: 'mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded' }, 'No se pudo cargar country.json / sectores.json.') : null,
                    loading ? React.createElement('div', { className: 'mt-3 text-sm text-slate-600' }, 'Leyendo PDF…') : null,
                    error ? React.createElement('div', { className: 'mt-3 text-sm text-red-600' }, error) : null,
                    pdfResumen ? React.createElement('div', { className: 'mt-3 text-xs text-slate-500' }, 'PDF: ' + pdfResumen.count + ' posiciones · ' + fmt(pdfResumen.total) + ' EUR') : null
                ),

                /* -------- Tabla acciones -------- */
                React.createElement('section', { className: 'overflow-auto card' },
                    React.createElement('table', { className: 'min-w-full text-sm' },
                        React.createElement('thead', null,
                            React.createElement('tr', null, [
                                { h: 'Nombre', k: 'nombre' }, { h: 'ISIN', k: 'isin' }, { h: 'Títulos', k: 'titulos' },
                                { h: 'Precio (€)', k: 'precio_eur' }, { h: 'Cotización (€)', k: 'cotizacion_eur' },
                                { h: 'Peso (%)', k: 'peso' }, { h: 'Sector', k: 'sector' }, { h: 'País', k: 'pais' }
                            ].map(col =>
                                React.createElement('th', {
                                    key: col.k, className: 'px-3 py-2 text-left font-semibold text-slate-600',
                                    onClick: () => onSort(col.k)
                                }, col.h, React.createElement('span', { className: 'sort-ind' }, sortArrow(col.k)))
                            )).props.children.concat(
                                React.createElement('th', { className: 'px-3 py-2 text-left th-static' },
                                    React.createElement('div', { className: 'flex items-center gap-2' },
                                        React.createElement('button', { title: 'Añadir posición', className: 'icon-circle', onClick: openAddModal, 'aria-label': 'Añadir' },
                                            React.createElement('svg', { viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 'stroke-width': '2', 'stroke-linecap': 'round', 'stroke-linejoin': 'round', width: 18, height: 18 },
                                                React.createElement('path', { d: 'M12 5v14M5 12h14' })
                                            )
                                        ),
                                        React.createElement('button', { title: 'Borrar todo', className: 'icon-danger', onClick: clearAll, 'aria-label': 'Borrar todo' },
                                            React.createElement('svg', { viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 'stroke-width': '2', 'stroke-linecap': 'round', 'stroke-linejoin': 'round', width: 18, height: 18 },
                                                React.createElement('polyline', { points: '3 6 5 6 21 6' }),
                                                React.createElement('path', { d: 'M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6' }),
                                                React.createElement('path', { d: 'M10 11v6M14 11v6' }),
                                                React.createElement('path', { d: 'M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2' })
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('tbody', null,
                            displayRows.map((r, idx) =>
                                React.createElement('tr', { key: (r.isin || '') + '#' + idx, className: (idx % 2 ? 'bg-slate-50' : '') },
                                    React.createElement('td', { className: 'px-3 py-2' }, r.nombre || ''),
                                    React.createElement('td', { className: 'px-3 py-2 mono' }, r.isin || ''),
                                    React.createElement('td', { className: 'px-3 py-2 mono' }, r.titulos != null ? fmt0(r.titulos) : ''),
                                    React.createElement('td', { className: 'px-3 py-2 mono' }, r.precio_eur != null ? fmt(r.precio_eur) : ''),
                                    React.createElement('td', { className: 'px-3 py-2 mono' }, r.cotizacion_eur != null ? fmt(r.cotizacion_eur) : ''),
                                    React.createElement('td', { className: 'px-3 py-2 mono' }, r.peso != null ? fmt1p(r.peso) : ''),
                                React.createElement('td', { className: 'px-3 py-2' }, r.sector || ''),
                                    React.createElement('td', { className: 'px-3 py-2' }, r.pais || ''),
                                    React.createElement('td', { className: 'px-3 py-2' },
                                        React.createElement('div', { className: 'row-actions' },
                                            // Solo Editar (sin borrar por fila)
                                            React.createElement('button', { title: 'Editar', className: 'icon-btn', onClick: () => openEditModal(r.isin), 'aria-label': 'Editar' },
                                                React.createElement('svg', { viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 'stroke-width': '2', 'stroke-linecap': 'round', 'stroke-linejoin': 'round', width: 18, height: 18 },
                                                    React.createElement('path', { d: 'M12 20h9' }),
                                                    React.createElement('path', { d: 'M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z' })
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('tfoot', null,
                            React.createElement('tr', { className: 'bg-slate-100 font-semibold' },
                                React.createElement('td', { className: 'px-3 py-2', colSpan: 2 }, 'Totales (visibles)'),
                                React.createElement('td', { className: 'px-3 py-2 mono' }, totalPosiciones),
                                React.createElement('td', { className: 'px-3 py-2 mono' }),
                                React.createElement('td', { className: 'px-3 py-2 mono' }, fmt(totalValorVisible)),
                                React.createElement('td', { className: 'px-3 py-2 mono' }, '100,0'),  /* sin % aquí */
                                React.createElement('td', { className: 'px-3 py-2' }),
                                React.createElement('td', { className: 'px-3 py-2' }),
                                React.createElement('td', { className: 'px-3 py-2' })
                            )
                        )
                    )
                ),

                /* -------- Análisis (donuts + tablas) -------- */
                showAnalysis ? React.createElement(React.Fragment, null,
                    React.createElement('section', { ref: analysisSectionRef, className: 'analysis-grid' },
                        // --- Sector ---
                        React.createElement('div', { className: 'analysis-card card' },
                            React.createElement('div', { className: 'analysis-body' },
                                React.createElement('h2', { className: 'text-xl md:text-2xl font-bold' }, 'Distribución por Sector'),
                                React.createElement('div', { className: 'chart-wrap' },
                                    React.createElement('canvas', { ref: sectorCanvasRef, className: 'chart-canvas' }),
                                    React.createElement('div', { ref: sectorTooltipRef, className: 'tooltip', style: { display: 'none' } })
                                )
                            ),
                            React.createElement('div', { className: 'analysis-footer' },
                                React.createElement('div', { className: 'chart-legend text-sm' },
                                    ...sectorAgg.map((d, i) =>
                                        React.createElement('span', { key: d.label, className: 'chip' },
                                            React.createElement('span', { className: 'chip-dot', style: { backgroundColor: PALETTE[i % PALETTE.length] } }),
                                            d.label
                                        )
                                    )
                                )
                            )
                        ),
                        // --- Región ---
                        React.createElement('div', { className: 'analysis-card card' },
                            React.createElement('div', { className: 'analysis-body' },
                                React.createElement('h2', { className: 'text-xl md:text-2xl font-bold' }, 'Distribución por Región'),
                                React.createElement('div', { className: 'chart-wrap' },
                                    React.createElement('canvas', { ref: regionCanvasRef, className: 'chart-canvas' }),
                                    React.createElement('div', { ref: regionTooltipRef, className: 'tooltip', style: { display: 'none' } })
                                )
                            ),
                            React.createElement('div', { className: 'analysis-footer' },
                                React.createElement('div', { className: 'chart-legend text-sm' },
                                    ['EEUU', 'Europa', 'Asia', 'Otros'].map(lbl => {
                                        const src = flagPaths[lbl];
                                        return React.createElement('span', { key: lbl, className: 'chip' },
                                            src ? React.createElement('img', { src, alt: lbl, className: 'chip-flag' }) :
                                                React.createElement('span', { className: 'chip-dot', style: { backgroundColor: lbl === 'Otros' ? '#f59e0b' : '#cbd5e1' } }),
                                            lbl
                                        );
                                    })
                                )
                            )
                        )
                    ),

                    /* --- Tablas de resumen bajo los diagramas --- */
                    /* --- Tablas de resumen bajo los diagramas (mismo ancho que los donuts) --- */
                    React.createElement('section', { className: 'grid md:grid-cols-2 gap-4 items-start' },
                        // Tabla Sector (mismo ancho que un donut)
                        React.createElement('div', { className: 'card overflow-auto' },
                            React.createElement('table', { className: 'min-w-full text-sm' },
                                React.createElement('thead', null,
                                    React.createElement('tr', null,
                                        ['Sector', 'Peso (%)', 'Valor (€)'].map(h =>
                                            React.createElement('th', { key: h, className: 'px-3 py-2 text-left font-semibold text-slate-600 th-static' }, h)
                                        )
                                    )
                                ),
                                React.createElement('tbody', null,
                                    sectorTable.map((s, idx) =>
                                        React.createElement('tr', { key: s.label, className: (idx % 2 ? 'bg-slate-50' : '') },
                                            React.createElement('td', { className: 'px-3 py-2' }, s.label),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, fmt1p(s.pct)),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, fmt(s.value))
                                        )
                                    )
                                )
                            )
                        ),

                        // Tabla Región (mismo ancho que un donut)
                        React.createElement('div', { className: 'card overflow-auto' },
                            React.createElement('table', { className: 'min-w-full text-sm' },
                                React.createElement('thead', null,
                                    React.createElement('tr', null,
                                        ['Región', 'Peso (%)', 'Valor (€)'].map(h =>
                                            React.createElement('th', { key: h, className: 'px-3 py-2 text-left font-semibold text-slate-600 th-static' }, h)
                                        )
                                    )
                                ),
                                React.createElement('tbody', null,
                                    regionTable.map((r, idx) =>
                                        React.createElement('tr', { key: r.label, className: (idx % 2 ? 'bg-slate-50' : '') },
                                            React.createElement('td', { className: 'px-3 py-2' }, r.label),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, fmt1p(r.pct)),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, fmt(r.value))
                                        )
                                    )
                                )
                            )
                        )
                    )
                ) : null,

                /* -------- Modal Añadir/Editar -------- */
                modalOpen ? React.createElement('div', { className: 'modal-backdrop', onClick: (e) => { if (e.target === e.currentTarget) closeModal(); } },
                    React.createElement('div', { className: 'modal-card', onClick: (e) => e.stopPropagation() },
                        React.createElement('div', { className: 'modal-header' },
                            React.createElement('div', { className: 'font-semibold' }, modalMode === 'add' ? 'Añadir por Ticker o ISIN' : 'Editar posición'),
                            React.createElement('button', { className: 'icon-btn', onClick: closeModal, 'aria-label': 'Cerrar' }, '✕')
                        ),
                        React.createElement('div', { className: 'modal-body space-y-3' },
                            React.createElement('div', null,
                                React.createElement('div', { className: 'label' }, 'Ticker (recomendado) o ISIN *'),
                                React.createElement('input', { className: 'input', value: form.tickerOrIsin, onChange: (e) => setForm(f => ({ ...f, tickerOrIsin: e.target.value })), onBlur: tryResolveFromTickerOrIsin, placeholder: 'MSFT, AAPL, V… o US5949181045' }),
                                formErrors.q ? React.createElement('div', { className: 'err' }, formErrors.q) : null,
                                React.createElement('div', { className: 'help' }, 'Se obtendrá nombre e ISIN automáticamente; se calculará precio en USD y se convertirá a EUR.')
                            ),
                            React.createElement('div', { className: 'grid-2' },
                                React.createElement('div', null,
                                    React.createElement('div', { className: 'label' }, 'ISIN (opcional)'),
                                    React.createElement('input', { className: 'input mono', value: form.isin, onChange: (e) => setForm(f => ({ ...f, isin: e.target.value.toUpperCase() })), onBlur: tryResolveFromExplicitIsin, placeholder: 'US5949181045' }),
                                    formErrors.isin ? React.createElement('div', { className: 'err' }, formErrors.isin) : null
                                ),
                                React.createElement('div', null,
                                    React.createElement('div', { className: 'label' }, 'Nombre (resuelto)'),
                                    React.createElement('input', { className: 'input', value: form.nameResolved, readOnly: true, placeholder: 'Se rellenará automáticamente' })
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('div', { className: 'label' }, 'Títulos *'),
                                React.createElement('input', { className: 'input mono', value: form.titulos, onChange: (e) => setForm(f => ({ ...f, titulos: e.target.value })), placeholder: '0,00' }),
                                formErrors.titulos ? React.createElement('div', { className: 'err' }, formErrors.titulos) : null
                            ),
                            React.createElement('div', { className: 'grid-2' },
                                React.createElement('div', null,
                                    React.createElement('div', { className: 'label' }, 'Sector (opcional)'),
                                    React.createElement('input', { className: 'input', list: 'sectors-list', value: form.sector, onChange: (e) => setForm(f => ({ ...f, sector: e.target.value })), placeholder: 'Tecnología, Salud, Consumo…' })
                                ),
                                React.createElement('div', null,
                                    React.createElement('div', { className: 'label' }, 'País (opcional; debe existir en country.json)'),
                                    React.createElement('input', { className: 'input', list: 'countries-list', value: form.pais, onChange: (e) => setForm(f => ({ ...f, pais: e.target.value })), placeholder: 'ES o España, US o United States…' }),
                                    formErrors.pais ? React.createElement('div', { className: 'err' }, formErrors.pais) : null
                                )
                            ),
                            countries ? React.createElement('datalist', { id: 'countries-list' }, Object.values(countries).map(n => React.createElement('option', { key: n, value: n }))) : null,
                            getSectorOptions().length ? React.createElement('datalist', { id: 'sectors-list' }, getSectorOptions().map(n => React.createElement('option', { key: n, value: n }))) : null
                        ),
                        React.createElement('div', { className: 'modal-footer' },
                            modalMode === 'edit'
                                ? React.createElement('button', { className: 'btn-danger', onClick: () => { if (confirm('¿Borrar esta posición?')) { deleteRow(editKey); closeModal(); } } }, 'Borrar')
                                : React.createElement(React.Fragment, null),
                            React.createElement('button', { className: 'btn', onClick: closeModal }, 'Cancelar'),
                            React.createElement('button', { className: 'btn-primary', onClick: saveModal }, modalMode === 'add' ? 'Añadir' : 'Guardar')
                        )
                    )
                ) : null,

                /* -------- Modal Detalle por porción (scrollable) -------- */
                detailOpen ? React.createElement('div', { className: 'modal-backdrop', onClick: (e) => { if (e.target === e.currentTarget) setDetailOpen(false); } },
                    React.createElement('div', { className: 'modal-card', onClick: (e) => e.stopPropagation() },
                        React.createElement('div', { className: 'modal-header' },
                            React.createElement('div', { className: 'font-semibold' },
                                'Detalle: ',
                                detailData.type === 'sector' ? 'Sector — ' : 'Región — ',
                                detailData.label,
                                ' · Total: €' + fmt(detailData.total)
                            ),
                            React.createElement('button', { className: 'icon-btn', onClick: () => setDetailOpen(false), 'aria-label': 'Cerrar' }, '✕')
                        ),
                        React.createElement('div', { className: 'modal-body space-y-3' },
                            React.createElement('table', { className: 'min-w-full text-sm' },
                                React.createElement('thead', null,
                                    React.createElement('tr', null,
                                        ['Nombre', 'ISIN', 'Cotización (€)', 'Peso en ' + (detailData.type === 'sector' ? 'sector' : 'región') + ' (%)'].map(h =>
                                            React.createElement('th', { key: h, className: 'px-3 py-2 text-left font-semibold text-slate-600 th-static' }, h)
                                        )
                                    )
                                ),
                                React.createElement('tbody', null,
                                    (detailData.items || []).map((r, idx) =>
                                        React.createElement('tr', { key: (r.isin || '') + '@' + idx, className: (idx % 2 ? 'bg-slate-50' : '') },
                                            React.createElement('td', { className: 'px-3 py-2' }, r.nombre || ''),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, r.isin || ''),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, r.cotizacion_eur != null ? fmt(r.cotizacion_eur) : ''),
                                            React.createElement('td', { className: 'px-3 py-2 mono' }, r.pesoGrupo != null ? fmt1p(r.pesoGrupo) : '')
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: 'modal-footer' },
                            React.createElement('button', { className: 'btn', onClick: () => setDetailOpen(false) }, 'Cerrar')
                        )
                    )
                ) : null,

                // datalists
                countries ? React.createElement('datalist', { id: 'countries-list' }, Object.values(countries).map(n => React.createElement('option', { key: n, value: n }))) : null,
                getSectorOptions().length ? React.createElement('datalist', { id: 'sectors-list' }, getSectorOptions().map(n => React.createElement('option', { key: n, value: n }))) : null
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
