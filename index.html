<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invest | Lector PDF cartera (v3.30 — alta manual con precio en EUR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      html, body { height: 100%; }
      .mono { font-variant-numeric: tabular-nums; }
      .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.125rem .5rem; border-radius:.5rem; font-size:.75rem; }
      table thead th { position: sticky; top: 0; background: #f1f5f9; }
      .btn { padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05); }
      .btn-primary { padding:.5rem .75rem; border-radius:.75rem; background:#0f172a; color:#fff; box-shadow:0 1px 2px rgba(0,0,0,.15); }
      .icon-btn { padding:.35rem .5rem; border-radius:.5rem; border:1px solid #cbd5e1; background:#fff; display:inline-flex; align-items:center; justify-content:center; }
      .icon-circle { width:28px; height:28px; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(0,0,0,.06); }
      .icon-circle:hover { background:#f8fafc; }
      .modal-backdrop { position: fixed; inset: 0; background: rgb(15 23 42 / 0.4); display: flex; align-items: center; justify-content: center; z-index: 50; }
      .modal-card { width: 100%; max-width: 720px; background: #fff; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
      .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
      .modal-body { padding: 1rem 1.25rem; }
      .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid #e2e8f0; display: flex; gap: .5rem; justify-content: flex-end; }
      .input { width: 100%; padding: .5rem .75rem; border: 1px solid #cbd5e1; border-radius: .75rem; }
      .input:focus { outline: none; box-shadow: 0 0 0 3px rgba(100,116,139,.2); border-color: #94a3b8; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
      .label { font-size: .8rem; color: #475569; }
      .help { font-size: .75rem; color: #64748b; }
      .err { font-size:.75rem; color:#b91c1c; margin-top:.25rem; }
      .row-actions { display:flex; align-items:center; gap:.35rem; }
      .th-actions { width:64px; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script>
      'use strict';

      const parseEsNumber = (s) => {
        if (s == null) return null;
        s = (''+s).replace(/\./g,'').replace(/,/g,'.').replace(/\s/g,'');
        const v = Number(s);
        return Number.isFinite(v) ? v : null;
      };
      const fmt = (n) => n != null ? n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
      const round2 = (n) => n==null?null:+(Math.round(n*100)/100).toFixed(2);

      function cleanNameBlock(block){
        if (!block) return '';
        let lines=String(block).split(/\n+/).map(s=>s.replace(/\s{2,}/g,' ').trim()).filter(Boolean);
        const headerRe=/(VALOR NOMINAL|NOMBRE DEL VALOR|PRECIO POR T[ÍI]TULO|COTIZACI[ÓO]N EN EUR|PA[ÍI]S DE CUSTODIA|TRADE REPUBLIC|EXTRACTO|CUENTA DE VALORES|RESUMEN|IBAN|BIC|DEP[ÓO]SITO)/i;
        lines=lines.filter(l=>!headerRe.test(l)&&!/t[íi]t\.?/i.test(l));
        if(!lines.length) return '';
        let line=lines[0];
        line=line.replace(/^\d[\d\.,]*\s*t[íi]t\.?\s*/i,'');
        line=line.split(/ISIN\s*:/i)[0].trim();
        const qual=/\b(Registered|Actions?|Acciones?|Shares?|Shs|ADR|ADS|Ord\.?|Bearer|Nominative|EO\b|DL\b|Class|Serie|Series|Port\.?|Nominal)\b/i;
        const qm=qual.exec(line); if(qm) line=line.slice(0,qm.index).trim();
        line=line.replace(/[·•\-–—,:;]+$/,'').trim();
        return line;
      }

      function buildBlocks(text){
        const re=/ISIN\s*:?[^A-Z0-9]*([A-Z0-9]{12})/gi;
        const matches=[]; let m;
        while((m=re.exec(text))!==null) matches.push({start:m.index, isin:m[1].toUpperCase()});
        const blocks=[];
        for(let i=0;i<matches.length;i++){
          const cur=matches[i];
          const nextStart=(i+1<matches.length)?matches[i+1].start:text.length;
          const pre=text.slice(Math.max(0,cur.start-600),cur.start);
          let post=text.slice(cur.start,nextStart);
          if (i === matches.length - 1) {
            post = post.replace(/N[ÚU]MERO\s+DE\s+POSICIONES[\s\S]*$/i, '');
            post = post.replace(/RESUMEN[\s\S]*$/i, '');
            post = post.replace(/TOTAL[\s\S]*$/i, '');
          }
          blocks.push({pre, post, isin:cur.isin});
        }
        return blocks;
      }

      function extractCotizacionEUR(post){
        const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
        if (!precioM) return null;
        const start = precioM.index + precioM[0].length;
        const ventana = post.slice(start, start + 200);
        const m = ventana.match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2}))\s*EUR/i);
        return m ? parseEsNumber(m[1]) : null;
      }

      function extractFromBlock({pre, post, isin}){
        const titMatchAll = pre.match(/([0-9][\d\.,]*)\s*t[íi]t\.?/gi);
        let titulos = null, lastTitNum = null;
        if (titMatchAll && titMatchAll.length){
          const last=titMatchAll[titMatchAll.length-1];
          const numM=/([0-9][\d\.,]*)/i.exec(last);
          titulos = numM ? parseEsNumber(numM[1]) : null;
          lastTitNum = numM ? numM[1] : null;
          if (titulos!=null && titulos>=1000000) titulos=null;
        }
        const nombreRaw = (lastTitNum!=null)
          ? pre.slice(pre.lastIndexOf(lastTitNum) + lastTitNum.length)
          : pre.split(/\n/).slice(-5).join('\n');
        const nombre = cleanNameBlock(nombreRaw);

        const precioM = /\n(\d{1,4}[\.,]\d{2})\b/.exec(post);
        const precio = precioM ? parseEsNumber(precioM[1]) : null;

        let cotizacion_eur = (precio!=null && titulos!=null) ? round2(precio * titulos) : null;
        const eurCercano = extractCotizacionEUR(post);
        if (eurCercano != null && cotizacion_eur != null && Math.abs(eurCercano - cotizacion_eur) <= 1.00) {
          cotizacion_eur = eurCercano;
        }

        return { nombre, isin, titulos, precio_eur: precio, cotizacion_eur };
      }

      function aggregateByISIN(rows){
        const map = new Map();
        for (const r of rows){
          const k = r.isin || '';
          if (!map.has(k)){
            map.set(k, { ...r });
          } else {
            const acc = map.get(k);
            const t1 = acc.titulos || 0, t2 = r.titulos || 0;
            const v1 = acc.cotizacion_eur || 0, v2 = r.cotizacion_eur || 0;
            const p1 = acc.precio_eur, p2 = r.precio_eur;

            acc.titulos = (t1 || t2) ? round2(t1 + t2) : (t1 || t2 || null);
            acc.cotizacion_eur = round2(v1 + v2);

            if ((t1 + t2) > 0 && (p1 != null || p2 != null)){
              const w1 = (p1!=null ? p1*t1 : 0), w2 = (p2!=null ? p2*t2 : 0);
              const denom = t1 + t2;
              acc.precio_eur = denom > 0 ? round2((w1 + w2) / denom) : (p1 ?? p2 ?? null);
            } else {
              acc.precio_eur = p1 ?? p2 ?? null;
            }
          }
        }
        return Array.from(map.values());
      }

      function reconcileToPdfTotal(rows, pdfTotal){
        if (!rows || !rows.length || pdfTotal == null) return rows;
        const target = +(+pdfTotal).toFixed(2);
        let sum = +rows.reduce((a,r)=>a+(r.cotizacion_eur||0),0).toFixed(2);
        const delta = +(target - sum).toFixed(2);
        if (delta === 0) return rows;
        let idxMax = -1, maxVal = -Infinity;
        for (let i=0;i<rows.length;i++){
          const v = rows[i].cotizacion_eur ?? -Infinity;
          if (v > maxVal){ maxVal = v; idxMax = i; }
        }
        if (idxMax >= 0){
          rows[idxMax] = { ...rows[idxMax], cotizacion_eur: round2((rows[idxMax].cotizacion_eur||0) + delta) };
        }
        return rows;
      }

      const { useState, useMemo, useEffect } = React;
      function App(){
        const [rows, setRows] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [filter, setFilter] = useState('');
        const [pdfResumen, setPdfResumen] = useState(null);

        const [countries, setCountries] = useState(null);
        const [sectors, setSectors]   = useState(null);
        const [jsonErr, setJsonErr]   = useState('');

        // Modal: ahora pediremos Ticker (o ISIN opcional) + Títulos
        const [modalOpen, setModalOpen] = useState(false);
        const [modalMode, setModalMode] = useState('add'); // 'add' | 'edit'
        const initialForm = { ticker:'', isin:'', titulos:'' };
        const [form, setForm] = useState(initialForm);
        const [formErrors, setFormErrors] = useState({});
        const [editKey, setEditKey] = useState(null);

        useEffect(() => {
          Promise.all([
            fetch('country.json').then(r => r.ok ? r.json() : Promise.reject('country.json no encontrado')),
            fetch('sectores.json').then(r => r.ok ? r.json() : Promise.reject('sectores.json no encontrado')),
          ]).then(([c,s]) => { setCountries(c); setSectors(s); })
            .catch(e => setJsonErr(String(e)));
        }, []);

        const countryFromISIN = (isin) => {
          if (!countries || !isin) return '';
          const m = String(isin).match(/^([A-Z]{2})/);
          const cc = m ? m[1] : null;
          return cc && countries[cc] ? countries[cc] : (cc || '');
        };
        const sectorFromISIN = (isin) => {
          if (!sectors || !isin) return '';
          return sectors[isin] || '';
        };

        const filtered = useMemo(() => {
          const q=(filter||'').toLowerCase();
          return rows.filter(r =>
            !q ||
            (r.nombre||'').toLowerCase().includes(q) ||
            (r.isin||'').toLowerCase().includes(q) ||
            (r.pais||'').toLowerCase().includes(q) ||
            (r.sector||'').toLowerCase().includes(q)
          );
        }, [rows, filter]);

        const totalValor = useMemo(() => +filtered.reduce((a,r)=>a+(r.cotizacion_eur||0),0).toFixed(2), [filtered]);
        const totalPosiciones = filtered.length;

        async function onFile(file){
          setError(''); setLoading(true);
          try {
            const pdfData=new Uint8Array(await file.arrayBuffer());
            const pdf=await pdfjsLib.getDocument({data:pdfData}).promise;
            let fullText='';
            for(let i=1;i<=pdf.numPages;i++){
              const page=await pdf.getPage(i);
              const content=await page.getTextContent();
              const pageText=content.items.map(it=>it.str).join('\n');
              fullText += '\n' + pageText + '\n';
            }
            const text = fullText.replace(/\u00A0/g,' ').replace(/\s+\n/g,'\n').replace(/\n{2,}/g,'\n');

            let data = aggregateByISIN(buildBlocks(text).map(extractFromBlock));
            data = data.map(r => ({
              ...r,
              pais: countryFromISIN(r.isin),
              sector: sectorFromISIN(r.isin)
            }));

            const resumenMatch = text.match(/N[ÚU]MERO\s+DE\s+POSICIONES:\s*(\d+)\s+(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)/i);
            const resumen = resumenMatch ? { count: Number(resumenMatch[1]), total: parseEsNumber(resumenMatch[2]) } : null;
            if (resumen && resumen.total != null){
              data = reconcileToPdfTotal(data, resumen.total);
            }

            setRows(data);
            setPdfResumen(resumen);
          } catch(e){
            setError('No se pudo leer el PDF. Asegúrate de subir el extracto original (ES).');
          } finally { setLoading(false); }
        }

        function exportCSV(){
          const csv = Papa.unparse(filtered.map(r => ({
            nombre:r.nombre, isin:r.isin, titulos:r.titulos, precio_eur:r.precio_eur,
            cotizacion_eur:r.cotizacion_eur, sector:r.sector, pais:r.pais
          })), { delimiter:';' });
          const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='cartera_export.csv'; a.click();
          URL.revokeObjectURL(url);
        }

        // ======= PRECIO EN EUR desde backend (usa /api/quote y, si hace falta, par FX) =======
        async function fetchPriceEUR(symbol){
          // 1) precio base
          const r = await fetch(`/api/quote?symbol=${encodeURIComponent(symbol)}`);
          const j = await r.json();
          if (!r.ok || j?.price == null) throw new Error(j?.error || 'quote error');
          let price = Number(j.price);
          let curr = j.currency || 'USD';
          // 2) conversión a EUR si es necesario
          if (curr !== 'EUR') {
            const pair = `${curr}EUR=X`;      // p. ej. USDEUR=X
            try{
              const rf = await fetch(`/api/quote?symbol=${encodeURIComponent(pair)}`);
              const jf = await rf.json();
              if (rf.ok && jf?.price != null) {
                const rate = Number(jf.price);
                price = round2(price * rate);
                curr = 'EUR';
              }
            }catch(_){}
          }
          return { price_eur: price, currency: curr, name: j.name || symbol };
        }

        // ---- Alta / Edición ----
        function openAddModal(){
          setModalMode('add');
          setEditKey(null);
          setForm(initialForm);
          setFormErrors({});
          setModalOpen(true);
        }
        function openEditModal(isin){
          const r = rows.find(x => x.isin === isin);
          if (!r) return;
          setModalMode('edit');
          setEditKey(isin);
          // Para edición mantenemos flujo anterior (manual total)
          setForm({ ticker: r.ticker || '', isin: r.isin || '', titulos: r.titulos ?? '' });
          setFormErrors({});
          setModalOpen(true);
        }
        function closeModal(){ setModalOpen(false); setForm(initialForm); setFormErrors({}); setEditKey(null); }

        function isISIN(v){ return /^[A-Z]{2}[A-Z0-9]{9}\d$/.test(String(v||'').toUpperCase()); }

        async function saveModal(){
          const tickerOrIsin = String(form.ticker||'').trim();
          const titulos = parseEsNumber(form.titulos);
          const maybeISIN = String(form.isin||'').trim().toUpperCase();
          const errs = {};
          if (!tickerOrIsin) errs.ticker = 'Obligatorio';
          if (!Number.isFinite(titulos)) errs.titulos = 'Número válido requerido';
          if (maybeISIN && !isISIN(maybeISIN)) errs.isin = 'ISIN inválido';
          setFormErrors(errs);
          if (Object.keys(errs).length) return;

          // elegimos pedir SIEMPRE el símbolo (ticker) por simplicidad del proveedor en tiempo real
          const symbol = isISIN(tickerOrIsin) ? null : tickerOrIsin.toUpperCase();
          let name = '';
          let precio_eur = null;

          try{
            const q = await fetchPriceEUR(symbol || 'AAPL'); // si puso ISIN por error, al menos intenta algo; mejor pide Ticker
            precio_eur = q.price_eur;
            name = q.name || symbol || maybeISIN;
          }catch(_e){
            alert('No se pudo obtener el precio en tiempo real. Se guardará sin precio.');
          }

          const isin = (maybeISIN && isISIN(maybeISIN)) ? maybeISIN : (isISIN(tickerOrIsin) ? tickerOrIsin.toUpperCase() : `@@${(symbol||'MANUAL')}`);
          const pais = isISIN(isin) ? (countryFromISIN(isin) || '') : '';
          const sector = isISIN(isin) ? (sectorFromISIN(isin) || '') : '';

          const row = {
            nombre: name || symbol || isin,
            isin,
            titulos,
            precio_eur: precio_eur,
            cotizacion_eur: (precio_eur!=null && Number.isFinite(titulos)) ? round2(precio_eur * titulos) : null,
            sector,
            pais,
            ticker: symbol || '' // guardamos por si luego quieres refrescar
          };

          if (modalMode === 'add'){
            // si no hay ISIN real, no agregamos por ISIN (porque se mezclarían vacíos). Usamos push directo.
            const next = isISIN(isin) ? aggregateByISIN([...rows, row]) : [...rows, row];
            setRows(next);
          } else {
            const next = rows.map(r => r.isin === editKey ? row : r);
            setRows(isISIN(isin) ? aggregateByISIN(next) : next);
          }
          closeModal();
        }

        function deleteRow(isin){
          const next = rows.filter(x => x.isin !== isin);
          setRows(next);
        }

        return React.createElement('div',{className:'max-w-7xl mx-auto p-4 md:p-8 space-y-6'},
          React.createElement('header',{className:'flex items-center justify-between gap-3 flex-wrap'},
            React.createElement('h1',{className:'text-2xl md:text-3xl font-bold'},'Invest · Lector de extractos (v3.30)'),
            React.createElement('div',{className:'flex items-center gap-2'},
              React.createElement('span',{className:'badge bg-slate-100 text-slate-700'},'Posiciones: '+totalPosiciones),
              React.createElement('span',{className:'badge bg-slate-100 text-slate-700'},'Valor: '+fmt(totalValor)+' EUR')
            ),
            React.createElement('div',{className:'flex items-center gap-2 grow md:grow-0'},
              React.createElement('button',{onClick:function(){const el=document.getElementById('file'); if(el) el.click();},className:'btn-primary'},'Subir PDF'),
              React.createElement('button',{onClick:exportCSV,className:'btn'},'Exportar CSV')
            )
          ),
          React.createElement('section',{className:'grid md:grid-cols-3 gap-4'},
            React.createElement('div',{className:'md:col-span-2 p-4 rounded-2xl bg-white shadow'},
              React.createElement('label',{className:'text-sm text-slate-500'},'Sube tu PDF de Trade Republic (ES):'),
              React.createElement('input',{id:'file',type:'file',accept:'application/pdf',style:{display:'none'},onChange:function(e){ if(e&&e.target&&e.target.files&&e.target.files[0]) onFile(e.target.files[0]); }}),
              (jsonErr && (!countries || !sectors)) ? React.createElement('div',{className:'mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded'}, 'No se pudo cargar country.json / sectores.json. Colócalos junto al HTML.'):null,
              loading?React.createElement('div',{className:'mt-4 text-sm text-slate-600'},'Leyendo PDF…'):null,
              error?React.createElement('div',{className:'mt-4 text-sm text-red-600'},error):null,
              pdfResumen?React.createElement('div',{className:'mt-2 text-sm text-slate-500'},'Resumen del PDF: '+pdfResumen.count+' posiciones · '+fmt(pdfResumen.total)+' EUR'):null
            ),
            React.createElement('div',{className:'p-4 rounded-2xl bg-white shadow space-y-3'},
              React.createElement('input',{className:'w-full px-3 py-2 rounded-xl border',placeholder:'Filtrar por nombre, ISIN, sector o país…',value:filter,onChange:function(e){ setFilter(e.target.value); }}),
              React.createElement('div',{className:'text-sm text-slate-500'},'Filas visibles: '+filtered.length),
              React.createElement('div',{className:'text-sm text-slate-500 mono'},'Total posiciones (visibles): '+totalPosiciones),
              React.createElement('div',{className:'text-sm text-slate-500 mono'},'Total valor (visibles): '+fmt(totalValor)+' EUR')
            )
          ),
          React.createElement('section',{className:'overflow-auto rounded-2xl bg-white shadow'},
            React.createElement('table',{className:'min-w-full text-sm'},
              React.createElement('thead',null,
                React.createElement('tr',null,
                  ['Nombre','ISIN','Títulos','Precio EUR','Cotización EUR','Sector','País'].map(h =>
                    React.createElement('th',{key:h,className:'px-3 py-2 text-left font-semibold text-slate-600'},h)
                  ),
                  React.createElement('th',{className:'px-3 py-2 text-left th-actions'},
                    React.createElement('button',{
                      title:'Añadir posición (Ticker/ISIN + Títulos)',
                      className:'icon-circle',
                      onClick: openAddModal,
                      'aria-label':'Añadir posición'
                    },
                      React.createElement('svg',{viewBox:'0 0 24 24', fill:'none', stroke:'currentColor', 'stroke-width':'2', 'stroke-linecap':'round', 'stroke-linejoin':'round'},
                        React.createElement('path',{d:'M12 5v14M5 12h14'})
                      )
                    )
                  )
                )
              ),
              React.createElement('tbody',null,
                filtered.map((r,idx) =>
                  React.createElement('tr',{key: r.isin || String(idx), className:(idx%2?'bg-slate-50':'')},
                    React.createElement('td',{className:'px-3 py-2'},r.nombre||''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.isin||''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.titulos!=null?r.titulos:''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.precio_eur!=null?fmt(r.precio_eur):''),
                    React.createElement('td',{className:'px-3 py-2 mono'},r.cotizacion_eur!=null?fmt(r.cotizacion_eur):''),
                    React.createElement('td',{className:'px-3 py-2'},r.sector||''),
                    React.createElement('td',{className:'px-3 py-2'},r.pais||''),
                    React.createElement('td',{className:'px-3 py-2'},
                      React.createElement('div',{className:'row-actions'},
                        React.createElement('button',{title:'Editar', className:'icon-btn', onClick:function(){ openEditModal(r.isin); }, 'aria-label':'Editar'},
                          React.createElement('svg',{viewBox:'0 0 24 24', fill:'none', stroke:'currentColor', 'stroke-width':'2', 'stroke-linecap':'round', 'stroke-linejoin':'round'},
                            React.createElement('path',{d:'M12 20h9'}),
                            React.createElement('path',{d:'M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z'})
                          )
                        ),
                        React.createElement('button',{title:'Eliminar', className:'icon-btn', onClick:function(){ if(confirm('¿Eliminar esta posición?')) deleteRow(r.isin); }, 'aria-label':'Eliminar'},
                          React.createElement('svg',{viewBox:'0 0 24 24', fill:'none', stroke:'currentColor', 'stroke-width':'2', 'stroke-linecap':'round', 'stroke-linejoin':'round'},
                            React.createElement('polyline',{points:'3 6 5 6 21 6'}),
                            React.createElement('path',{d:'M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6'}),
                            React.createElement('path',{d:'M10 11v6M14 11v6'}),
                            React.createElement('path',{d:'M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2'})
                          )
                        )
                      )
                    )
                  )
                )
              ),
              React.createElement('tfoot',null,
                React.createElement('tr',{className:'bg-slate-100 font-semibold'},
                  React.createElement('td',{className:'px-3 py-2',colSpan:2},'Totales (visibles)'),
                  React.createElement('td',{className:'px-3 py-2 mono'},totalPosiciones),
                  React.createElement('td',{className:'px-3 py-2 mono'}),
                  React.createElement('td',{className:'px-3 py-2 mono'},fmt(totalValor)),
                  React.createElement('td',{className:'px-3 py-2'}),
                  React.createElement('td',{className:'px-3 py-2'}),
                  React.createElement('td',{className:'px-3 py-2'})
                )
              )
            )
          ),
          // ---- Modal (Añadir / Editar) — solo Ticker/ISIN + Títulos; el resto se calcula ----
          modalOpen ? React.createElement('div',{className:'modal-backdrop', onClick: function(e){ if (e.target === e.currentTarget) closeModal(); }},
            React.createElement('div',{className:'modal-card', onClick: function(e){ e.stopPropagation(); }},
              React.createElement('div',{className:'modal-header'},
                React.createElement('div', {className:'font-semibold'}, modalMode==='add' ? 'Añadir por Ticker o ISIN' : 'Editar posición'),
                React.createElement('button',{className:'icon-btn', onClick: closeModal, 'aria-label':'Cerrar'}, '✕')
              ),
              React.createElement('div',{className:'modal-body space-y-3'},
                React.createElement('div', null,
                  React.createElement('div',{className:'label'},'Ticker (recomendado) o ISIN *'),
                  React.createElement('input',{className:'input', value:form.ticker, onChange:function(e){ setForm(f=>({...f,ticker:e.target.value})); }, placeholder:'V, AAPL, MSFT… o US92826C8394'}),
                  formErrors.ticker ? React.createElement('div',{className:'err'}, formErrors.ticker) : null,
                  React.createElement('div',{className:'help'},'Usa el símbolo del mercado (p. ej., V para Visa). Si añades ISIN, rellena también el campo ISIN inferior para país/sector.')
                ),
                React.createElement('div', {className:'grid-2'},
                  React.createElement('div', null,
                    React.createElement('div',{className:'label'},'Títulos *'),
                    React.createElement('input',{className:'input mono', value:form.titulos, onChange:function(e){ setForm(f=>({...f,titulos:e.target.value})); }, placeholder:'0,00'}),
                    formErrors.titulos ? React.createElement('div',{className:'err'}, formErrors.titulos) : null
                  ),
                  React.createElement('div', null,
                    React.createElement('div',{className:'label'},'ISIN (opcional, para país/sector)'),
                    React.createElement('input',{className:'input mono', value:form.isin, onChange:function(e){ setForm(f=>({...f,isin:e.target.value.toUpperCase()})); }, placeholder:'US92826C8394'}),
                    formErrors.isin ? React.createElement('div',{className:'err'}, formErrors.isin) : null
                  )
                ),
                React.createElement('div',{className:'help'},'Al guardar, se buscará el precio actual, se convertirá a EUR y se calculará la cotización.')
              ),
              React.createElement('div',{className:'modal-footer'},
                React.createElement('button',{className:'btn', onClick: closeModal},'Cancelar'),
                React.createElement('button',{className:'btn-primary', onClick: saveModal}, modalMode==='add' ? 'Añadir' : 'Guardar')
              )
            )
          ) : null
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
