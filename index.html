<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inversiones — MVP (sin build)</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- pdf.js (para extraer texto) -->
  <script src="https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
  <style>
    /* Evita zoom en inputs numéricos en iOS */
    input[type=number] { font-size: 16px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="p-4 md:p-6 border-b bg-white sticky top-0 z-10">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
      <h1 class="text-2xl md:text-3xl font-semibold">💹 Inversiones — MVP</h1>
      <div class="text-sm text-slate-500">100% estático · funciona con doble clic</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    <!-- Controles principales -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="p-4 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Importar / Exportar</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Importar CSV (posiciones)</label>
            <input id="csvInput" type="file" accept=".csv,text/csv" class="block w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Importar PDF (Trade Republic / MyInvestor)</label>
            <input id="pdfInput" type="file" accept="application/pdf" class="block w-full" multiple />
            <div class="flex items-center gap-3 mt-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="overwriteISIN" class="rounded" checked> Sobrescribir por ISIN al importar</label>
              <span class="text-xs text-slate-400">(puedes seleccionar varios PDF a la vez)</span>
            </div>
            <p class="text-xs text-slate-500 mt-1">Parsers básicos. Pásame PDFs reales para afinar aún más.</p>
          </div>
          <div class="flex gap-2">
            <button id="btnExportJSON" class="px-3 py-2 bg-slate-900 text-white rounded-xl">Exportar JSON</button>
            <label class="px-3 py-2 bg-slate-100 rounded-xl cursor-pointer">
              Importar JSON
              <input id="jsonInput" type="file" accept="application/json" class="hidden" />
            </label>
          </div>
        </div>
      </div>

      <div class="p-4 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Precios</h2>
        <div class="space-y-2">
          <button id="btnUpdatePrices" class="px-3 py-2 bg-emerald-600 text-white rounded-xl">Actualizar precios (beta)</button>
          <div class="flex items-center gap-2">
            <input id="autoRefresh" type="checkbox" class="rounded" />
            <label for="autoRefresh" class="text-sm">Auto-actualizar cada 15 min (usa tus tickers guardados)</label>
          </div>
          <p class="text-xs text-slate-500">Usa <strong>ticker</strong> si está disponible. Para ISIN global sin ticker, añade el símbolo manualmente o importa CSV del broker.</p>
        </div>
      </div>

      <div class="p-4 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Persistencia</h2>
        <div class="space-y-2">
          <button id="btnSaveLS" class="px-3 py-2 bg-indigo-600 text-white rounded-xl">Guardar en este navegador</button>
          <button id="btnLoadLS" class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-xl">Cargar de este navegador</button>
          <button id="btnMergeISIN" class="px-3 py-2 bg-amber-500 text-white rounded-xl">Fusionar por ISIN (PMP)</button>
          <button id="btnReset" class="px-3 py-2 bg-rose-600 text-white rounded-xl">Reset</button>
        </div>
      </div>
    </section>

    <!-- Alta manual -->
    <section class="p-4 bg-white rounded-2xl shadow">
      <h2 class="font-semibold mb-3">Añadir posición</h2>
      <form id="addForm" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 items-end">
        <div>
          <label class="block text-xs mb-1">ISIN</label>
          <input name="isin" required placeholder="ES0143416115" class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Ticker (opcional)</label>
          <input name="ticker" placeholder="AAPL" class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Nombre</label>
          <input name="nombre" placeholder="Apple Inc." class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Cantidad</label>
          <input name="qty" type="number" step="0.0001" min="0" required class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Precio medio</label>
          <input name="avgCost" type="number" step="0.0001" min="0" required class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Precio actual</label>
          <input name="price" type="number" step="0.0001" min="0" class="w-full border rounded-xl p-2" placeholder="opcional" />
        </div>
        <div>
          <label class="block text-xs mb-1">Moneda</label>
          <input name="currency" placeholder="EUR/USD" class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Sector</label>
          <input name="sector" placeholder="Tecnología" class="w-full border rounded-xl p-2" />
        </div>
        <div>
          <label class="block text-xs mb-1">Broker</label>
          <input name="broker" placeholder="TR / MI" class="w-full border rounded-xl p-2" />
        </div>
        <div class="col-span-2 md:col-span-4 lg:col-span-8">
          <button class="px-3 py-2 bg-slate-900 text-white rounded-xl">Añadir</button>
        </div>
      </form>
    </section>

    <!-- Tabla -->
    <section class="p-4 bg-white rounded-2xl shadow">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Posiciones</h2>
        <div class="text-sm text-slate-500" id="summary"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="tbl">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">ISIN</th>
              <th class="text-left p-2">Nombre</th>
              <th class="text-right p-2">Cant.</th>
              <th class="text-right p-2">Valor</th>
              <th class="text-left p-2">Sector</th>
              <th class="text-left p-2">Región</th>
              <th class="text-right p-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Distribución por sector</h2>
        <canvas id="sectorChart" height="200"></canvas>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Valor por región</h2>
        <canvas id="brokerChart" height="200"></canvas>
      </div>
    </section>

    <footer class="pt-6 pb-8 text-center text-xs text-slate-500">MVP v0.1 — LocalStorage · CSV · PDF básico · Charts</footer>
  </main>

<script>
// ====== Estado ======
const LS_KEY = 'inv_state_v2';
/** @type {{positions: Array<{id:string,isin:string,ticker?:string,nombre?:string,qty:number,avgCost:number,price?:number,currency?:string,sector?:string,broker?:string}>}} */
let state = { positions: [] };

// Config PDF.js worker (necesario en Pages/CDN)
if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.worker.min.js';
}

function uid() { return Math.random().toString(36).slice(2, 10); }

function loadFromLocalStorage() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) {
    try { state = JSON.parse(raw); } catch {}
    render();
  }
}
function saveToLocalStorage() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

// ====== PDF.js fallback loader (Pages/CDN safe) ======
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error('No se pudo cargar: ' + src));
    document.head.appendChild(s);
  });
}
async function ensurePdfJs() {
  if (window.pdfjsLib) return; // ya cargado (unpkg)
  // Fallback estable (UMD) desde cdnjs 3.x
  await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
  if (!window.pdfjsLib) throw new Error('pdfjsLib no disponible tras fallback');
  if (pdfjsLib.GlobalWorkerOptions) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
}

// ====== Render ======
let sectorChart, brokerChart;

function currency(value) {
  if (value == null || isNaN(value)) return '-';
  return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 }).format(value);
}

function render() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  let totalValor = 0, totalCoste = 0;

  for (const p of state.positions) {
    const valor = (p.price ?? 0) * p.qty;
    const coste = (p.avgCost ?? 0) * p.qty;
    totalValor += valor;
    totalCoste += coste;

    const tr = document.createElement('tr');
    tr.className = 'border-b';
    tr.innerHTML = `
      <td class="p-2">${escapeHtml(p.isin)}</td>
      <td class="p-2">${escapeHtml(p.nombre || '')}</td>
      <td class="p-2 text-right">${fmtNum(p.qty)}</td>
      <td class="p-2 text-right">${currency((p.price ?? 0) * (p.qty ?? 0))}</td>
      <td class="p-2">${escapeHtml(p.sector || sectorGuess(p) || 'Sin sector')}</td>
      <td class="p-2">${escapeHtml(getRegion(p))}</td>
      <td class="p-2 text-right">
        <button class="text-rose-600 hover:underline" data-del="${p.id}">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  }

  document.getElementById('summary').textContent = `Valor: ${currency(totalValor)}`;

  renderCharts();
}

function fmtNum(n) {
  const v = Number(n);
  if (!isFinite(v)) return '-';
  return new Intl.NumberFormat('es-ES', { maximumFractionDigits: 4 }).format(v);
}

function escapeHtml(s) { return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

function renderCharts() {
  const bySector = aggregateBy(state.positions, p => (p.sector || sectorGuess(p) || 'Sin sector'));
  const byRegion = aggregateBy(state.positions, p => getRegion(p));

  const sectorLabels = Object.keys(bySector);
  const sectorData = sectorLabels.map(k => bySector[k]);
  const regionLabels = Object.keys(byRegion);
  const regionData = regionLabels.map(k => byRegion[k]);

  const ctx1 = document.getElementById('sectorChart');
  const ctx2 = document.getElementById('brokerChart');

  if (sectorChart) sectorChart.destroy();
  if (brokerChart) brokerChart.destroy();

  sectorChart = new Chart(ctx1, {
    type: 'pie',
    data: { labels: sectorLabels, datasets: [{ data: sectorData }] },
    options: { responsive: true }
  });
  brokerChart = new Chart(ctx2, {
    type: 'bar',
    data: { labels: regionLabels, datasets: [{ data: regionData }] },
    options: { responsive: true, scales: { y: { beginAtZero: true }}}
  });
}


function aggregateBy(items, keyFn) {
  const acc = {};
  for (const p of items) {
    const key = keyFn(p);
    const valor = (p.price ?? 0) * (p.qty ?? 0);
    acc[key] = (acc[key] ?? 0) + valor;
  }
  return acc;
}

// ===== Helpers de sector y región =====
const EUROPE_CODES = new Set(['AT','BE','BG','CH','CY','CZ','DE','DK','EE','ES','FI','FR','GB','GR','HR','HU','IE','IS','IT','LI','LT','LU','LV','MT','NL','NO','PL','PT','RO','SE','SI','SK']);
const ASIA_CODES = new Set(['CN','HK','JP','KR','TW','SG','IN','ID','TH','MY','PH','VN','AE','SA','QA','KW']);
function countryNameEs(code){
  const map={US:'Estados Unidos', ES:'España', FR:'Francia', DE:'Alemania', DK:'Dinamarca', NL:'Países Bajos', IE:'Irlanda', LU:'Luxemburgo', IT:'Italia', GB:'Reino Unido', CH:'Suiza', SE:'Suecia', NO:'Noruega', FI:'Finlandia', PT:'Portugal', BE:'Bélgica', AT:'Austria', PL:'Polonia', CZ:'Chequia', HU:'Hungría', GR:'Grecia', CN:'China', HK:'Hong Kong', JP:'Japón', KR:'Corea del Sur', TW:'Taiwán', SG:'Singapur', IN:'India'};
  return map[code]||code;
}
function regionFromISIN(isin){
  if(!isin||isin.length<2) return 'Desconocido';
  const code = isin.slice(0,2).toUpperCase();
  if (code==='US') return 'EEUU';
  if (EUROPE_CODES.has(code)) return 'Europa';
  if (ASIA_CODES.has(code)) return 'Asia';
  return countryNameEs(code);
}
function getRegion(p){ return p.region || regionFromISIN(p.isin); }

const SECTOR_OVERRIDES = {
  'DK0062498333':'Salud', // Novo Nordisk B
  'FR0000120628':'Finanzas', // AXA
  'CNE100000296':'Consumo cíclico', // BYD Company
};
function sectorGuess(p){
  if (!p) return 'Sin sector';
  if (p.sector && p.sector.trim()) return p.sector;
  const o = SECTOR_OVERRIDES[p.isin]; if (o) return o;
  const name = (p.nombre||'').toLowerCase();
  if (/bank|banco|financial|insurance|assur|axa|santander|bbva|hsbc/.test(name)) return 'Finanzas';
  if (/pharma|pharmaceutical|health|biotech|novo nordisk|sanofi|roche|johnson|abbvie|merck/.test(name)) return 'Salud';
  if (/(auto|automotive|motor|byd|tesla|bmw|volkswagen|stellantis)/.test(name)) return 'Consumo cíclico';
  if (/(semiconductor|chip|foundry|asml|tsmc|nvidia|intel|amd)/.test(name)) return 'Tecnología';
  if (/(software|cloud|saas|microsoft|adobe|salesforce|oracle)/.test(name)) return 'Tecnología';
  if (/(energy|oil|gas|petro|shell|total|exxon|chevron|repsol)/.test(name)) return 'Energía';
  if (/(reit|realty|inmobili|property)/.test(name)) return 'Real Estate';
  if (/(consumer|lvmh|l'oreal|nestle|procter|unilever|coca-cola|pepsico)/.test(name)) return 'Consumo defensivo';
  if (/(telecom|telef|verizon|att|orange|vodafone)/.test(name)) return 'Telecomunicaciones';
  if (/(industrial|aerospace|siemens|honeywell|ge|thales)/.test(name)) return 'Industria';
  if (/(utility|utilities|iberdrola|enel|edf|e\.on)/.test(name)) return 'Utilities';
  return 'Sin sector';
}

function mergePositionsByISIN(list) {
  const map = new Map();
  for (const p of list) {
    if (!p || !p.isin) continue;
    const key = String(p.isin).toUpperCase();
    if (!map.has(key)) {
      map.set(key, {
        id: uid(),
        isin: key,
        qty: 0,
        _cost: 0,
        price: undefined,
        currency: p.currency || 'EUR',
        tickerSet: new Set(),
        nombreSet: new Set(),
        sectorSet: new Set(),
        brokerSet: new Set(),
      });
    }
    const acc = map.get(key);
    acc.qty += Number(p.qty || 0);
    acc._cost += Number(p.avgCost || 0) * Number(p.qty || 0);
    if (p.price != null) acc.price = Number(p.price);
    if (p.ticker) acc.tickerSet.add(p.ticker);
    if (p.nombre) acc.nombreSet.add(p.nombre);
    if (p.sector) acc.sectorSet.add(p.sector);
    if (p.broker) acc.brokerSet.add(p.broker);
    if (!acc.currency && p.currency) acc.currency = p.currency;
  }
  const out = [];
  for (const acc of map.values()) {
    const avgCost = acc.qty ? acc._cost / acc.qty : 0;
    out.push({
      id: acc.id,
      isin: acc.isin,
      ticker: acc.tickerSet.size ? [...acc.tickerSet][0] : undefined,
      nombre: acc.nombreSet.size ? [...acc.nombreSet][0] : undefined,
      qty: Number(acc.qty.toFixed(6)),
      avgCost: Number(avgCost.toFixed(6)),
      price: acc.price,
      currency: acc.currency,
      sector: acc.sectorSet.size ? [...acc.sectorSet][0] : '',
      broker: acc.brokerSet.size ? [...acc.brokerSet].join(', ') : ''
    });
  }
  return out;
}

function upsertByISIN(incoming, { overwrite = true } = {}) {
  if (!incoming || !incoming.isin) return;
  const key = String(incoming.isin).toUpperCase();
  const idx = state.positions.findIndex(x => x.isin === key);
  if (idx >= 0) {
    const cur = state.positions[idx];
    const updated = {
      ...cur,
      nombre: incoming.nombre || cur.nombre,
      qty: overwrite && isFinite(incoming.qty) ? Number(incoming.qty) : cur.qty,
      avgCost: overwrite && isFinite(incoming.avgCost) ? Number(incoming.avgCost) : cur.avgCost,
      price: overwrite && isFinite(incoming.price) ? Number(incoming.price) : cur.price,
      currency: incoming.currency || cur.currency,
      ticker: cur.ticker || incoming.ticker,
      broker: cur.broker || incoming.broker,
    };
    updated.sector = sectorGuess(updated);
    updated.region = regionFromISIN(updated.isin);
    state.positions[idx] = updated;
  } else {
    const p = { ...incoming, isin: key };
    p.ticker = p.ticker || undefined;
    p.sector = sectorGuess(p);
    p.region = regionFromISIN(p.isin);
    state.positions.push(p);
  }
}

// ====== Eventos ======

document.getElementById('addForm').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const pos = {
    id: uid(),
    isin: String(fd.get('isin')||'').trim().toUpperCase(),
    ticker: String(fd.get('ticker')||'').trim().toUpperCase() || undefined,
    nombre: String(fd.get('nombre')||'').trim(),
    qty: Number(fd.get('qty')),
    avgCost: Number(fd.get('avgCost')),
    price: fd.get('price') ? Number(fd.get('price')) : undefined,
    currency: String(fd.get('currency')||'').trim().toUpperCase() || 'EUR',
    sector: String(fd.get('sector')||'').trim(),
    broker: String(fd.get('broker')||'').trim(),
  };
  state.positions.push(pos);
  saveToLocalStorage();
  e.target.reset();
  render();
});

document.getElementById('tbody').addEventListener('click', e => {
  const btn = e.target.closest('[data-del]');
  if (btn) {
    const id = btn.getAttribute('data-del');
    state.positions = state.positions.filter(p => p.id !== id);
    saveToLocalStorage();
    render();
  }
});

// CSV
const csvInput = document.getElementById('csvInput');
csvInput.addEventListener('change', () => {
  const file = csvInput.files?.[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: ({ data }) => {
      const mapped = mapCsvRows(data);
      if (!mapped.length) { alert('No se detectaron filas válidas en el CSV'); return; }
      const overwrite = document.getElementById('overwriteISIN')?.checked ?? true;
      for (const m of mapped) {
        upsertByISIN({ ...m, id: uid() }, { overwrite });
      }
      saveToLocalStorage();
      render();
    }
  });
});

function mapCsvRows(rows) {
  const out = [];
  for (const r of rows) {
    const obj = normalizeKeys(r);
    const isin = (obj.isin || obj['isincode'] || obj['isin_number'] || '').toUpperCase();
    const ticker = (obj.ticker || obj.symbol || obj.simbolo || obj['símbolo'] || '').toUpperCase();
    const nombre = obj.nombre || obj.name || '';
    const qty = Number(obj.cantidad || obj.qty || obj.shares || obj.unidades || 0);
    const avgCost = Number((obj.preciomedio ?? obj['precio medio'] ?? obj.averagecost ?? obj.avgcost ?? obj.ppc ?? obj.ppm ?? obj.price ?? 0));
    const price = obj.precioactual ? Number(obj.precioactual) : undefined;
    const currency = (obj.divisa || obj.moneda || obj.currency || 'EUR').toUpperCase();
    const sector = obj.sector || '';
    const broker = obj.broker || obj.plataforma || '';
    if (!isin || !qty || !avgCost) continue;
    out.push({ isin, ticker, nombre, qty, avgCost, price, currency, sector, broker });
  }
  return out;
}

function normalizeKeys(o) {
  const m = {};
  for (const k in o) {
    const nk = String(k).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
    m[nk] = typeof o[k] === 'string' ? o[k].trim() : o[k];
  }
  return m;
}

// JSON import/export
 document.getElementById('btnExportJSON').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'inversiones.json'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('jsonInput').addEventListener('change', () => {
  const f = document.getElementById('jsonInput').files?.[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try { state = JSON.parse(reader.result); saveToLocalStorage(); render(); }
    catch { alert('JSON inválido'); }
  };
  reader.readAsText(f);
});

// LocalStorage
 document.getElementById('btnSaveLS').addEventListener('click', () => { saveToLocalStorage(); alert('Guardado en este navegador.'); });
 document.getElementById('btnLoadLS').addEventListener('click', () => { loadFromLocalStorage(); alert('Cargado desde este navegador.'); });
 document.getElementById('btnReset').addEventListener('click', () => {
  if (!confirm('¿Seguro que quieres borrar todas las posiciones?')) return;
  state = { positions: [] }; saveToLocalStorage(); render();
});

document.getElementById('btnMergeISIN').addEventListener('click', () => {
  const before = state.positions.length;
  state.positions = mergePositionsByISIN(state.positions);
  saveToLocalStorage();
  render();
  alert(`Fusionadas por ISIN: ${before} → ${state.positions.length}`);
});

// PDF (extrae texto y busca patrones)
const pdfInput = document.getElementById('pdfInput');
pdfInput.addEventListener('change', async () => {
  const files = Array.from(pdfInput.files || []);
  if (!files.length) return;
  const overwrite = document.getElementById('overwriteISIN')?.checked ?? true;
  try {
    let parsedAll = [];
    for (const file of files) {
      const rawText = await extractPdfText(file);
      const text = rawText.replace(/Code ISIN/gi, 'ISIN: ');
      const parsed = parseKnownStatements(text);
      parsedAll.push(...parsed);
    }
    if (!parsedAll.length) { alert('No se detectaron posiciones en los PDF.'); return; }
    for (const p of parsedAll) {
      upsertByISIN({ ...p, id: uid() }, { overwrite });
    }
    saveToLocalStorage();
    render();
  } catch (e) {
    console.error(e);
    alert('No se pudo leer el PDF: ' + (e?.message || e?.toString() || 'error desconocido'));
  }
});

async function extractPdfText(file) {
  await ensurePdfJs();
  const array = await file.arrayBuffer();
  // Intento 1: con worker
  try {
    const pdf = await pdfjsLib.getDocument({ data: array }).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const c = await page.getTextContent();
      text += '\n' + c.items.map(it => it.str).join(' ');
    }
    return text;
  } catch (e1) {
    console.warn('PDF.js worker falló, reintentando sin worker…', e1);
    const pdf = await pdfjsLib.getDocument({ data: array, disableWorker: true }).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const c = await page.getTextContent();
      text += '\n' + c.items.map(it => it.str).join(' ');
    }
    return text;
  }
}

// --- Parser TR/FR robusto: delimita por ISIN y dedupe por ISIN ---
function parseKnownStatements(text) {
  // Normaliza: colapsa espacios y acepta “Code ISIN”
  const t = text
    .replace(/\s+/g, ' ')
    .replace(/Code\s*ISIN\s*[:：]?/gi, 'ISIN: ')
    .trim();

  // Números con miles/decimales mixtos + quita fechas dd.mm.yyyy / dd/mm/yyyy
  const reNum = /(?:\d{1,3}(?:[\.\s]\d{3})+|\d+)(?:[\.,]\d+)?/g;
  const toNum = (s) => Number(
    s.replace(/\s/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.')
  );
  const stripFechas = (s) => s.replace(/\d{2}[./-]\d{2}[./-]\d{4}/g, ' ');

  const isinRe = /ISIN:\s*([A-Z]{2}[A-Z0-9]{9}\d)/g;
  const matches = [...t.matchAll(isinRe)];
  const outMap = new Map(); // dedupe por ISIN

  for (let i = 0; i < matches.length; i++) {
    const m = matches[i];
    const isin = m[1];
    const prevEnd = i > 0 ? matches[i-1].index + matches[i-1][0].length : 0;
    const curStart = m.index;

    // Bloque anterior entre este ISIN y el anterior: suele contener el nombre correcto
    const block = t.slice(prevEnd, curStart).trim();

    // Nombre = última frase “de texto” antes del ISIN (evita colarse "ISIN")
    let nombre;
    const nameCand = block.match(/[A-Za-z0-9À-ÿ\.,'’`\-() ]{3,120}$/);
    if (nameCand) {
      const s = nameCand[0].trim();
      if (!/ISIN/i.test(s)) nombre = s;
    }

    // Qty: último número en el bloque anterior (si existe)
    const numsLeft = [...block.matchAll(reNum)].map(x => toNum(x[0])).filter(Number.isFinite);
    const qty = numsLeft.length ? numsLeft[numsLeft.length - 1] : undefined;

    // Precio/Valor: primeros números a la derecha del ISIN, ignorando fechas
    const rightWin = stripFechas(t.slice(curStart, Math.min(t.length, curStart + 200)));
    const numsRight = [...rightWin.matchAll(reNum)].map(x => toNum(x[0])).filter(Number.isFinite);
    const price = numsRight[0];
    const value = numsRight[1];

    // Consolida por ISIN (prefiere nombre más largo y datos no vacíos)
    const prev = outMap.get(isin) || {};
    outMap.set(isin, {
      isin,
      nombre: (!prev.nombre || (nombre && nombre.length > prev.nombre.length)) ? nombre : prev.nombre,
      qty: Number.isFinite(qty) ? qty : prev.qty,
      price: Number.isFinite(price) ? price
           : (Number.isFinite(value) && Number.isFinite(qty) ? value/qty : prev.price),
      currency: 'EUR',
      broker: 'Trade Republic'
    });
  }
  return [...outMap.values()];
}

// ====== Precios (beta, sin garantías de CORS) ======
document.getElementById('btnUpdatePrices').addEventListener('click', updatePrices);

async function updatePrices() {
  const tickers = [...new Set(state.positions.map(p => p.ticker).filter(Boolean))]; // usamos ticker si existe; ISIN no soportado por Yahoo directamente
  if (!tickers.length) { alert('No hay tickers.'); return; }
  const chunks = chunk(tickers, 40);
  let okCount = 0, failCount = 0;
  for (const ch of chunks) {
    try {
      const quotes = await yahooQuotes(ch);
      for (const q of quotes) {
        const p = state.positions.find(p => p.ticker === (q.symbol || '').toUpperCase());
        if (p && isFinite(q.regularMarketPrice)) { p.price = Number(q.regularMarketPrice); okCount++; }
      }
    } catch(e) { console.warn('Chunk failed', e); failCount += ch.length; }
  }
  saveToLocalStorage();
  render();
  {
  const msg = `Precios actualizados: ${okCount} ok${failCount ? ', ' + failCount + ' con fallo/CORS' : ''}`;
  alert(msg);
}
}

async function yahooQuotes(symbols) {
  const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const j = await r.json();
    return j.quoteResponse?.result || [];
  } catch (e) {
    // Fallback vía proxy CORS genérico (puede caer)
    const proxy = 'https://cors.isomorphic-git.org/';
    const r2 = await fetch(proxy + url);
    if (!r2.ok) throw new Error('Proxy HTTP ' + r2.status);
    const j2 = await r2.json();
    return j2.quoteResponse?.result || [];
  }
}

function chunk(arr, n) { const out=[]; for (let i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n)); return out; }

// ====== Init ======
loadFromLocalStorage();
render();

// Auto-refresh precios cada 15 min si está activado
let _autoTimer = null;
const autoCb = document.getElementById('autoRefresh');
function setAutoRefresh(on){
  if (_autoTimer) { clearInterval(_autoTimer); _autoTimer = null; }
  if (on) {
    _autoTimer = setInterval(() => { updatePrices().catch(()=>{}); }, 15*60*1000);
    // Dispara una actualización inicial
    updatePrices().catch(()=>{});
  }
}
if (autoCb) {
  autoCb.addEventListener('change', () => setAutoRefresh(autoCb.checked));
}

// ====== Self-tests (básicos) ======
(function selfTests(){
  const tests = [];
  const assert = (name, cond) => tests.push({ name, ok: !!cond });
  try {
    // 1) Parser TR/FR: dos ISIN distintos y sin duplicar nombre
    const fake = `Merck KGaA Inhaber-Aktien o.N. ISIN: DE0006599905 Allianz SE vink.Namens-Aktien o.N. ISIN: DE0008404005`;
    const parsed = parseKnownStatements(fake);
    const isins = new Set(parsed.map(x=>x.isin));
    assert('Parser devuelve 2 entradas', parsed.length === 2);
    assert('ISIN únicos', isins.size === 2);
    const names = parsed.map(x=>x.nombre||'').join(' ');
    assert('Nombres contienen Merck y Allianz', /Merck/i.test(names) && /Allianz/i.test(names));

    // 2) Región por ISIN
    assert('DE -> Europa', regionFromISIN('DE0008404005') === 'Europa');

    // 3) aggregateBy suma valores
    const agg = aggregateBy([{qty:2,price:10,sector:'X'},{qty:1,price:20,sector:'X'}], p=>p.sector);
    assert('Aggregate sector X = 40', agg['X'] === 40);
  } catch(err){ console.warn('Self-tests error:', err); }
  const failed = tests.filter(t=>!t.ok);
  if (failed.length) {
    console.warn('Self-tests fallidos:', failed);
  } else {
    console.log('Self-tests OK:', tests.map(t=>t.name));
  }
})();
</script>
</body>
</html>
